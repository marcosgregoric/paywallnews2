<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Paywall News - Marketplace de Noticias</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0b0b0d;
  --bg-secondary: #07070a;
  --card: #111217;
  --text: #ffffff;
  --text-secondary: #9aa0a6;
  --muted: #6c757d;
  --accent: #ff3b30;
  --accent-hover: #ff5449;
  --border: rgba(255,255,255,0.06);
  --shadow: rgba(0,0,0,0.3);
  --overlay: rgba(0,0,0,0.7);
  --watermark: rgba(255,255,255,0.1);
  --success: #34c759;
  --warning: #ffcc00;
  --info: #0a84ff;
  --gold: #ffd700;
}

body.light {
  --bg: #f8f9fa;
  --bg-secondary: #ffffff;
  --card: #ffffff;
  --text: #1a1a1a;
  --text-secondary: #6c757d;
  --muted: #adb5bd;
  --accent: #ff3b30;
  --border: rgba(0,0,0,0.08);
  --shadow: rgba(0,0,0,0.1);
  --watermark: rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); transition: background 0.3s; -webkit-font-smoothing: antialiased; }

header { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
.brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }

.container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 110px; }

/* MAPA */
.map-container { height: 360px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 24px; position: relative; border: 1px solid var(--border); z-index: 1; }
#map { height: 100%; width: 100%; }
.map-legend { position: absolute; left: 16px; bottom: 16px; background: var(--overlay); backdrop-filter: blur(10px); padding: 12px; border-radius: 12px; font-size: 12px; z-index: 1000; color: white; display: flex; gap: 12px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

/* GRID Y CARDS */
.news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
.news-card { background: var(--card); border-radius: 16px; overflow: hidden; position: relative; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border); }
.news-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px var(--shadow); }
.news-card-image { width: 100%; aspect-ratio: 16/10; position: relative; }
.news-card-image img { width: 100%; height: 100%; object-fit: cover; }

/* CORRECCI√ìN 4: MARCA DE AGUA (PAYWALL NEWS M√ÅS GRANDE) */
.watermark-overlay { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); pointer-events: none; z-index: 5; overflow: hidden; }
.watermark-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-25deg); color: var(--watermark); text-align: center; }
.wm-brand { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
.wm-user { font-size: 7px; font-weight: 400; margin-top: 2px; }

.price-badge { position: absolute; top: 12px; right: 12px; background: var(--overlay); color: white; padding: 6px 10px; border-radius: 8px; font-weight: 700; z-index: 10; font-size: 13px; }
.license-badge { position: absolute; top: 12px; left: 12px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; z-index: 10; }
.license-exclusive { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.license-nonexclusive { background: rgba(0, 122, 255, 0.9); color: white; }

/* CORRECCI√ìN 3: GR√ÅFICO PEQUE√ëO Y D√çAS DIN√ÅMICOS */
.stats-container { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border); }
.chart-wrapper { height: 180px; width: 100%; margin-top: 15px; }

/* MODAL Y NEGOCIACI√ìN (CORRECCI√ìN 1) */
.modal { position: fixed; inset: 0; background: var(--overlay); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
.modal.active { display: flex; }
.modal-content { background: var(--card); border-radius: 20px; max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; }
.offer-section { background: var(--bg); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-top: 20px; }
.quick-offers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
.quick-offer-btn { background: var(--card); border: 2px solid var(--border); padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
.quick-offer-btn:hover { border-color: var(--gold); }
.quick-offer-btn div:first-child { font-weight: 800; font-size: 18px; }
.timer-box { background: rgba(255, 59, 48, 0.1); padding: 12px; border-radius: 10px; text-align: center; margin: 15px 0; border: 1px solid var(--accent); }
.timer-countdown { font-family: monospace; font-size: 26px; font-weight: 700; color: var(--accent); }

/* BOTONES Y FORMS */
.btn { padding: 14px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; width: 100%; }
.btn-primary { background: var(--accent); color: white; }
.btn-gold { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.btn-secondary { background: var(--border); color: var(--text); }

/* LISTAS UNIFICADAS (CORRECCI√ìN 3) */
.list-item { display: flex; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); align-items: center; }
.list-item-img { width: 70px; height: 50px; border-radius: 8px; object-fit: cover; }
.list-item-content { flex: 1; }
.list-item-title { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
.list-item-date { font-size: 12px; color: var(--text-secondary); }

/* BOTTOM NAV */
.bottom-nav { position: fixed; left: 16px; right: 16px; bottom: 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; display: flex; padding: 8px; z-index: 100; box-shadow: 0 8px 32px var(--shadow); }
.nav-item { flex: 1; text-align: center; padding: 8px; border-radius: 12px; cursor: pointer; font-size: 11px; color: var(--text-secondary); position: relative; }
.nav-item.active { color: var(--accent); background: rgba(255, 59, 48, 0.1); font-weight: 700; }
.notif-badge { position: absolute; top: 4px; right: 30%; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: none; }
.notif-badge.active { display: block; animation: pulse 2s infinite; }

@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
</style>
</head>
<body class="dark">

<header>
  <div class="brand">üì∞ Paywall News</div>
  <div style="display:flex; gap:15px">
    <button id="themeToggle" style="background:none; border:none; cursor:pointer; font-size:20px">üåô</button>
    <button onclick="showView('profile')" style="background:none; border:none; cursor:pointer; font-size:20px">üë§</button>
  </div>
</header>

<div class="container">
  
  <div id="view-home" class="view active">
    <div class="map-container">
        <div id="map"></div>
        <div class="map-legend">
            <div><span class="legend-dot" style="background:#ff3b30"></span> Alta</div>
            <div><span class="legend-dot" style="background:#ffcc00"></span> Media</div>
            <div><span class="legend-dot" style="background:#4cd964"></span> Baja</div>
        </div>
    </div>
    <h2 style="margin-bottom:15px">Noticias Destacadas</h2>
    <div class="news-grid" id="homeGrid"></div>
  </div>

  <div id="view-discover" class="view" style="display:none">
    <h2 style="margin-bottom:15px">Explorar Mercado</h2>
    <div style="margin-bottom:20px; display:flex; gap:10px">
        <input type="text" id="searchInput" placeholder="Buscar #hashtags o t√≠tulos..." style="flex:1; padding:14px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--text)">
        <select id="filterCategory" style="padding:10px; border-radius:12px; background:var(--card); color:var(--text); border:1px solid var(--border)">
            <option value="all">Todo</option>
            <option value="exclusive">Exclusivas</option>
        </select>
    </div>
    <div class="news-grid" id="discoverGrid"></div>
  </div>

  <div id="view-upload" class="view" style="display:none">
    <h2 style="margin-bottom:15px">Subir Contenido</h2>
    <div class="stats-container">
        <form id="uploadForm">
            <input type="file" id="fileInput" style="margin-bottom:15px; width:100%">
            <input type="text" id="titleInput" placeholder="T√≠tulo de la noticia" style="width:100%; padding:12px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text)">
            <input type="text" id="hashtagsInput" placeholder="#etiquetas" style="width:100%; padding:12px; margin-bottom:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text)">
            <input type="number" id="priceInput" placeholder="Precio Base (USD)" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text)">
            <button type="submit" class="btn btn-primary">üì§ Publicar noticia</button>
        </form>
    </div>
  </div>

  <div id="view-sales" class="view" style="display:none">
    <div class="stats-container">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <strong>üìä Rendimiento</strong>
            <div style="display:flex; gap:5px; background:var(--bg); padding:4px; border-radius:8px">
                <button class="tab-btn active" onclick="updateChart('week', this)">S</button>
                <button class="tab-btn" onclick="updateChart('month', this)">M</button>
                <button class="tab-btn" onclick="updateChart('year', this)">A</button>
            </div>
        </div>
        <div class="chart-wrapper"><canvas id="earningsChart"></canvas></div>
    </div>

    <div id="pendingOffersCard" style="display:none; margin-bottom:20px; border:2px solid var(--warning); border-radius:16px; padding:15px; background:rgba(255,204,0,0.05)">
        <h3 style="color:var(--warning); margin-bottom:10px">üîî Ofertas para responder</h3>
        <div id="offersList"></div>
    </div>

    <div class="stats-container">
        <h3 style="margin-bottom:15px">Ventas Realizadas</h3>
        <div id="salesList"></div>
    </div>

    <div class="stats-container">
        <h3 style="margin-bottom:15px">Mis Compras</h3>
        <div id="purchasesList"></div>
    </div>
  </div>

  <div id="view-wallet" class="view" style="display:none">
    <div class="stats-container" style="text-align:center; padding:40px">
        <div style="font-size:14px; color:var(--text-secondary)">Saldo disponible</div>
        <div id="walletBalance" style="font-size:48px; font-weight:800; margin:10px 0">$250.00</div>
        <button class="btn btn-primary" onclick="alert('Solicitud enviada')">üí∏ Retirar fondos</button>
    </div>
  </div>

  <div id="view-profile" class="view" style="display:none">
    <div class="stats-container" style="text-align:center">
        <div style="font-size:60px">üë§</div>
        <h2>Juan P√©rez</h2>
        <p style="color:var(--text-secondary)">juan.perez@email.com</p>
    </div>
    <div class="stats-container" style="cursor:pointer" onclick="showView('accounts')">
        <div style="display:flex; justify-content:space-between">
            <span>üë• Cuentas vinculadas</span>
            <span>3 ‚Ä∫</span>
        </div>
    </div>
  </div>

  <div id="view-accounts" class="view" style="display:none">
    <h2 style="margin-bottom:15px">Subcuentas</h2>
    <div id="subaccountsList"></div>
  </div>

</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="showView('home')">üè†<br>Inicio</div>
  <div class="nav-item" onclick="showView('discover')">üîç<br>Explorar</div>
  <div class="nav-item" onclick="showView('upload')">üì§<br>Subir</div>
  <div class="nav-item" onclick="showView('sales')">
    <div id="navNotif" class="notif-badge"></div>üìä<br>Ventas
  </div>
  <div class="nav-item" onclick="showView('wallet')">üí∞<br>Billetera</div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between">
      <h3 id="modalTitle"></h3>
      <button onclick="closeModal()" style="background:none; border:none; color:var(--text); font-size:24px; cursor:pointer">‚úï</button>
    </div>
    <div id="modalBody" style="padding:20px"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ============ DATOS √çNTEGROS ============
const currentUser = { name: "Juan P√©rez", balance: 250 };
let feed = [
  {id:1,title:'Accidente Av. Mitre',price:50,lat:-34.6037,lng:-58.3816,img:'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800',licenseType:'nonexclusive',status:'for_sale',importance:'high'},
  {id:2,title:'Incendio F√°brica Quilmes',price:120,lat:-34.6070,lng:-58.3772,img:'https://images.unsplash.com/photo-1577962917302-cd874c4e31d2?w=800',licenseType:'nonexclusive',status:'for_sale',importance:'medium'},
  {id:3,title:'Manifestaci√≥n Obelisco',price:80,lat:-34.6037,lng:-58.3816,img:'https://images.unsplash.com/photo-1590856029826-c7a73142bbf1?w=800',licenseType:'exclusive',status:'for_sale',importance:'high'}
];
let negotiations = [];
let salesHistory = [
    {title: 'Choque en Panamericana', amount: 150, date: '10/12/2025 14:30', img: 'https://images.unsplash.com/photo-1558882224-dda166733046?w=100'}
];
let purchases = [
    {title: 'Corte de luz masivo', price: 45, date: '09/12/2025 10:15'}
];
let subaccounts = [
    {name: 'C√°mara Norte', files: 12, img: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100'},
    {name: 'Dron Sur', files: 7, img: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100'}
];

let earningsChart = null;
let activeInterval = null;
const cashSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2012/2012-preview.mp3');

// ============ RENDERIZADO CORREGIDO ============
function generateWatermark() {
  let cells = '';
  for(let i=0; i<9; i++) {
    cells += `<div class="watermark-cell"><span class="wm-brand">Paywall News</span><span class="wm-user">${currentUser.name}</span></div>`;
  }
  return `<div class="watermark-overlay">${cells}</div>`;
}

function renderNewsGrid(id, items) {
  const container = document.getElementById(id);
  if(!container) return;
  container.innerHTML = items.map(item => `
    <div class="news-card" onclick="openDetail(${item.id})">
      <div class="news-card-image">
        <img src="${item.img}">
        ${item.status !== 'sold' ? generateWatermark() : ''}
        <div class="price-badge">$${item.price}</div>
        <div class="license-badge ${item.licenseType === 'exclusive' ? 'license-exclusive' : 'license-nonexclusive'}">
            ${item.licenseType === 'exclusive' ? 'üèÜ EXCLUSIVA' : 'üåê SHARED'}
        </div>
      </div>
      <div style="padding:15px">
        <div class="list-item-title">${item.title}</div>
        <small style="color:${item.status === 'for_sale' ? 'var(--success)' : 'var(--warning)'}">${item.status === 'for_sale' ? '‚óè Disponible' : '‚óè Negociando'}</small>
      </div>
    </div>`).join('');
}

// CORRECCI√ìN 1: PANEL DE NEGOCIACI√ìN COMPLETO
function openDetail(id) {
  const item = feed.find(x => x.id === id);
  if(item.status === 'sold') return;
  
  document.getElementById('modalTitle').textContent = item.title;
  document.getElementById('modalBody').innerHTML = `
    <div style="position:relative; border-radius:12px; overflow:hidden; margin-bottom:15px">
        <img src="${item.img}" style="width:100%">
        ${generateWatermark()}
    </div>
    <button class="btn btn-primary" style="margin-bottom:10px" onclick="alert('Compra procesada')">Comprar Licencia Est√°ndar ($${item.price})</button>
    <div class="offer-section">
        <h4 style="text-align:center; color:var(--gold); margin-bottom:15px">Solicitar Exclusividad</h4>
        <div class="quick-offers">
            <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*2})"><div>X2</div><div>$${item.price*2}</div></div>
            <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*3})"><div>X3</div><div>$${item.price*3}</div></div>
            <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*4})"><div>X4</div><div>$${item.price*4}</div></div>
        </div>
        <div style="display:flex; gap:10px">
            <input type="number" id="customOffer" placeholder="Valor manual" style="flex:1; padding:12px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:white">
            <button class="btn btn-gold" style="width:auto" onclick="sendCustomOffer(${item.id})">Enviar</button>
        </div>
    </div>`;
  document.getElementById('modal').classList.add('active');
}

// ============ SISTEMA DE VENTAS Y GR√ÅFICO (CORRECCI√ìN 3) ============
function initChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    earningsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'],
            datasets: [{ data: [60, 90, 40, 150, 100, 220, 80], backgroundColor: '#ff3b30', borderRadius: 4 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            }
        }
    });
}

function updateChart(period, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    let labels, data;
    if(period === 'week') { labels = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom']; data = [60, 90, 40, 150, 100, 220, 80]; }
    else if(period === 'month') { labels = ['Sem 1','Sem 2','Sem 3','Sem 4']; data = [500, 850, 600, 1100]; }
    else { labels = ['2023','2024','2025']; data = [6000, 9500, 12000]; }

    earningsChart.data.labels = labels;
    earningsChart.data.datasets[0].data = data;
    earningsChart.update();
}

function renderSales() {
    // CORRECCI√ìN 3: Formato unificado de fecha y nombre
    document.getElementById('salesList').innerHTML = salesHistory.length ? salesHistory.map(s => `
        <div class="list-item">
            <img src="${s.img}" class="list-item-img">
            <div class="list-item-content">
                <div class="list-item-title">${s.title}</div>
                <div class="list-item-date">${s.date}</div>
            </div>
            <strong style="color:var(--success)">+$${s.amount}</strong>
        </div>`).join('') : '<p style="text-align:center; color:var(--muted)">Sin ventas a√∫n.</p>';

    document.getElementById('purchasesList').innerHTML = purchases.map(p => `
        <div class="list-item">
            <div style="width:70px; height:50px; background:var(--bg); border-radius:8px; display:flex; align-items:center; justify-content:center">üìÑ</div>
            <div class="list-item-content">
                <div class="list-item-title">${p.title}</div>
                <div class="list-item-date">${p.date}</div>
            </div>
            <strong style="color:var(--accent)">-$${p.price}</strong>
        </div>`).join('');

    const pending = negotiations.filter(n => n.status === 'pending');
    document.getElementById('pendingOffersCard').style.display = pending.length ? 'block' : 'none';
    document.getElementById('offersList').innerHTML = pending.map(n => `
        <div class="list-item" style="background:var(--bg); border-radius:12px; margin-bottom:10px">
            <div class="list-item-content"><strong>Oferta de $${n.amount}</strong><br><small>Expira en 15m</small></div>
            <button class="btn btn-primary" style="width:auto; padding:8px 15px" onclick="showSellerPanel(${n.id})">Gestionar</button>
        </div>`).join('');
}

function showSellerPanel(negId) {
    const neg = negotiations.find(n => n.id === negId);
    const item = feed.find(f => f.id === neg.newsId);
    document.getElementById('modalTitle').textContent = 'Oferta Recibida';
    document.getElementById('modalBody').innerHTML = `
        <div class="timer-box">
            <small>TIEMPO DE RESPUESTA</small>
            <div id="countdown" class="timer-countdown">15:00</div>
        </div>
        <div style="text-align:center; padding:20px; background:var(--bg); border-radius:15px; margin-bottom:15px">
            <h1 style="color:var(--gold); font-size:42px">$${neg.amount}</h1>
            <p>${item.title}</p>
        </div>
        <button class="btn btn-primary" onclick="acceptOffer(${negId})">ACEPTAR Y COBRAR</button>`;
    document.getElementById('modal').classList.add('active');
    startCountdown(negId);
}

// ============ OTROS CONTROLES ============
function makeOffer(itemId, amount) {
    const expiresAt = Date.now() + (15 * 60 * 1000);
    negotiations.push({ id: negotiations.length+1, newsId: itemId, amount, status: 'pending', expiresAt });
    feed.find(x => x.id === itemId).status = 'negotiating';
    document.getElementById('navNotif').classList.add('active');
    closeModal(); renderAllViews();
}

function sendCustomOffer(itemId) {
    const val = Number(document.getElementById('customOffer').value);
    if(val > 0) makeOffer(itemId, val);
}

function acceptOffer(id) {
    const neg = negotiations.find(n => n.id === id);
    const item = feed.find(f => f.id === neg.newsId);
    cashSound.play().catch(()=>{});
    item.status = 'sold';
    neg.status = 'accepted';
    salesHistory.unshift({title: item.title, amount: neg.amount, date: new Date().toLocaleString(), img: item.img});
    document.getElementById('navNotif').classList.remove('active');
    closeModal(); renderAllViews();
}

function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
  document.querySelectorAll('.nav-item').forEach(i => {
    i.classList.remove('active');
    if(i.textContent.includes(name === 'home' ? 'Inicio' : name === 'discover' ? 'Explorar' : name === 'upload' ? 'Subir' : name === 'sales' ? 'Ventas' : 'Billetera')) i.classList.add('active');
  });
  document.getElementById(`view-${name}`).style.display = 'block';
  
  if(name === 'sales') { renderSales(); if(!earningsChart) initChart(); }
  if(name === 'discover') renderNewsGrid('discoverGrid', feed);
  if(name === 'accounts') renderSubaccounts();
}

function renderSubaccounts() {
    document.getElementById('subaccountsList').innerHTML = subaccounts.map(acc => `
        <div class="list-item">
            <img src="${acc.img}" class="list-item-img" style="border-radius:50%; width:50px; height:50px">
            <div class="list-item-content">
                <div class="list-item-title">${acc.name}</div>
                <div class="list-item-date">${acc.files} archivos</div>
            </div>
        </div>`).join('');
}

function startCountdown(negId) {
    if(activeInterval) clearInterval(activeInterval);
    activeInterval = setInterval(() => {
        const neg = negotiations.find(n => n.id === negId);
        if(!neg) return;
        const diff = neg.expiresAt - Date.now();
        if(diff <= 0) { clearInterval(activeInterval); closeModal(); return; }
        const mins = Math.floor(diff/60000);
        const secs = Math.floor((diff%60000)/1000);
        const el = document.getElementById('countdown');
        if(el) el.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
}

function closeModal() { document.getElementById('modal').classList.remove('active'); clearInterval(activeInterval); }
function renderAllViews() { renderNewsGrid('homeGrid', feed); renderSales(); }

// INIT
let map = L.map('map', {zoomControl: false}).setView([-34.6037, -58.3816], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
document.getElementById('themeToggle').onclick = () => document.body.classList.toggle('light');
document.getElementById('searchInput').oninput = (e) => {
    const val = e.target.value.toLowerCase();
    const filtered = feed.filter(i => i.title.toLowerCase().includes(val));
    renderNewsGrid('discoverGrid', filtered);
};
renderAllViews();
</script>
</body>
</html>