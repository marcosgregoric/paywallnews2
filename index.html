<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Paywall News - Marketplace Profesional</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ========== ESTILOS ORIGINALES √çNTEGROS ========== */
:root {
  --bg: #0b0b0d;
  --bg-secondary: #07070a;
  --card: #111217;
  --text: #ffffff;
  --text-secondary: #9aa0a6;
  --muted: #6c757d;
  --accent: #ff3b30;
  --accent-hover: #ff5449;
  --border: rgba(255,255,255,0.06);
  --shadow: rgba(0,0,0,0.3);
  --overlay: rgba(0,0,0,0.7);
  --watermark: rgba(255,255,255,0.08);
  --success: #34c759;
  --warning: #ffcc00;
  --info: #0a84ff;
  --gold: #ffd700;
}

body.light {
  --bg: #f8f9fa; --bg-secondary: #ffffff; --card: #ffffff;
  --text: #1a1a1a; --text-secondary: #6c757d; --border: rgba(0,0,0,0.08);
  --watermark: rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

/* HEADER ORIGINAL */
header { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
.brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }

/* CONTENEDOR PRINCIPAL */
.container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 110px; }

/* MAPA Y COMPONENTES VISUALES */
.map-container { height: 360px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 24px; position: relative; border: 1px solid var(--border); }
#map { height: 100%; width: 100%; }

/* GRID DE NOTICIAS */
.news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
.news-card { background: var(--card); border-radius: 16px; overflow: hidden; position: relative; cursor: pointer; transition: 0.3s; border: 1px solid var(--border); }
.news-card:hover { transform: translateY(-4px); }

/* MEJORA: MARCA DE AGUA (Invertida como pediste) */
.watermark-overlay { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); pointer-events: none; z-index: 5; }
.watermark-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-25deg); color: var(--watermark); }
.wm-brand { font-size: 12px; font-weight: 900; text-transform: uppercase; }
.wm-user { font-size: 8px; font-weight: 400; margin-top: 2px; }

/* BADGES ORIGINALES */
.price-badge { position: absolute; top: 12px; right: 12px; background: var(--overlay); color: white; padding: 6px 10px; border-radius: 8px; font-weight: 700; z-index: 10; }
.license-badge { position: absolute; top: 12px; left: 12px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; z-index: 10; }
.license-exclusive { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.license-nonexclusive { background: rgba(0, 122, 255, 0.95); color: white; }

/* COMPONENTES DE VISTA VENTAS (Gr√°fico corregido) */
.stats-container { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border); }
.chart-wrapper { height: 180px; width: 100%; }
.stats-tabs { display: flex; gap: 8px; background: var(--bg); padding: 4px; border-radius: 10px; }
.tab-btn { padding: 6px 12px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 12px; font-weight: 600; }
.tab-btn.active { background: var(--card); color: var(--accent); }

/* ESTILOS DE SUBIR (RECUPERADOS) */
.license-option { padding: 16px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
.license-option.selected { border-color: var(--accent); background: rgba(255, 59, 48, 0.05); }

/* BOTTOM NAV Y NOTIF */
.bottom-nav { position: fixed; left: 16px; right: 16px; bottom: 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; display: flex; padding: 8px; z-index: 100; box-shadow: 0 8px 32px var(--shadow); }
.nav-item { flex: 1; text-align: center; padding: 8px; cursor: pointer; font-size: 11px; color: var(--text-secondary); position: relative; }
.nav-item.active { color: var(--accent); font-weight: 700; }
.notif-badge { position: absolute; top: 4px; right: 30%; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; display: none; }
.notif-badge.active { display: block; animation: pulse 2s infinite; }

/* MODAL PROFESIONAL */
.modal { position: fixed; inset: 0; background: var(--overlay); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
.modal.active { display: flex; }
.modal-content { background: var(--card); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }

/* NEGOCIACI√ìN */
.offer-section { background: var(--bg); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-top: 15px; }
.timer-box { background: rgba(255, 59, 48, 0.1); padding: 12px; border-radius: 10px; text-align: center; margin-bottom: 15px; border: 1px solid var(--accent); }
.timer-countdown { font-family: monospace; font-size: 24px; font-weight: 700; color: var(--accent); }

@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<header>
  <div class="brand">üì∞ Paywall News</div>
  <div style="display:flex; gap:15px">
    <button id="themeToggle" style="background:none; border:none; cursor:pointer; font-size:20px">üåô</button>
    <button onclick="showView('profile')" style="background:none; border:none; cursor:pointer; font-size:20px">üë§</button>
  </div>
</header>

<div class="container">
  
  <div id="view-home" class="view active">
    <div class="map-container"><div id="map"></div></div>
    <div class="section-header"><h2 class="section-title">Noticias en Tiempo Real</h2></div>
    <div class="news-grid" id="homeGrid"></div>
  </div>

  <div id="view-discover" class="view" style="display:none">
    <h2 style="margin-bottom:15px">Explorar Mercado</h2>
    <div style="margin-bottom:20px; display:grid; grid-template-columns: 1fr auto; gap:10px">
        <input type="text" id="searchInput" placeholder="Buscar #hashtags, t√≠tulos..." style="padding:14px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--text)">
        <button class="btn btn-secondary" onclick="alert('Modal filtros original')" style="width:auto">‚öôÔ∏è</button>
    </div>
    <div id="trendingHashtags" style="margin-bottom:20px; overflow-x:auto; white-space:nowrap"></div>
    <div class="news-grid" id="discoverGrid"></div>
  </div>

  <div id="view-upload" class="view" style="display:none">
    <h2>Subir Nueva Noticia</h2>
    <div class="stats-container" style="margin-top:20px">
        <form id="uploadForm">
            <div style="margin-bottom:15px">
                <label>T√≠tulo</label>
                <input type="text" id="titleInput" class="form-input" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text)">
            </div>
            <div style="margin-bottom:15px">
                <label>Hashtags (Sugerencias üî•: <span id="uploadTrendTags"></span>)</label>
                <input type="text" id="hashtagsInput" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text)">
            </div>
            <div style="margin-bottom:15px">
                <label>Licencia</label>
                <div class="license-option selected" onclick="selectLic(this, 'nonexclusive')">üåê Compartida (Venta m√∫ltiple)</div>
                <div class="license-option" onclick="selectLic(this, 'exclusive')">üèÜ Exclusiva (Un solo due√±o)</div>
                <input type="hidden" id="licenseInput" value="nonexclusive">
            </div>
            <button type="submit" class="btn btn-primary">üì§ Publicar Contenido</button>
        </form>
    </div>
  </div>

  <div id="view-sales" class="view" style="display:none">
    <div class="stats-container">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <strong>Rendimiento de Ventas</strong>
            <div class="stats-tabs">
                <button class="tab-btn active" onclick="updateChart('week', this)">Semana</button>
                <button class="tab-btn" onclick="updateChart('month', this)">Mes</button>
                <button class="tab-btn" onclick="updateChart('year', this)">A√±o</button>
            </div>
        </div>
        <div class="chart-wrapper"><canvas id="earningsChart"></canvas></div>
    </div>

    <div id="pendingOffersCard" style="display:none; margin-bottom:20px; border:2px solid var(--warning); border-radius:16px; padding:20px">
        <h3 style="color:var(--warning)">üîî Ofertas de Compradores</h3>
        <div id="offersList"></div>
    </div>

    <div class="stats-container">
        <h3>Ventas Realizadas</h3>
        <div id="salesList"></div>
    </div>
    
    <div class="stats-container">
        <h3>Compras Realizadas</h3>
        <div id="purchasesList"></div>
    </div>
  </div>

  <div id="view-wallet" class="view" style="display:none">
    <div class="stats-container" style="text-align:center; padding:40px">
        <div style="font-size:14px; color:var(--text-secondary)">Saldo a favor</div>
        <div id="walletBalance" style="font-size:48px; font-weight:800; margin:10px 0">$250.00</div>
        <button class="btn btn-primary" onclick="alert('Retiro solicitado')">üí∏ Retirar Ganancias</button>
    </div>
  </div>

  <div id="view-profile" class="view" style="display:none">
    <div class="stats-container" style="text-align:center">
        <div style="font-size:60px">üë§</div>
        <h2 id="profileName">Juan P√©rez</h2>
        <p>Miembro Verificado ‚úì</p>
    </div>
    <div class="stats-container" onclick="showView('accounts')" style="cursor:pointer">
        <h3>üë• Cuentas Vinculadas (Subcuentas)</h3>
        <div id="subaccountsList" style="margin-top:15px"></div>
    </div>
  </div>

</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="showView('home')">üè†<br>Inicio</div>
  <div class="nav-item" onclick="showView('discover')">üîç<br>Explorar</div>
  <div class="nav-item" onclick="showView('upload')">üì§<br>Subir</div>
  <div class="nav-item" onclick="showView('sales')"><div id="navNotif" class="notif-badge"></div>üìä<br>Ventas</div>
  <div class="nav-item" onclick="showView('wallet')">üí∞<br>Billetera</div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between">
      <h3 id="modalTitle">Detalle de Noticia</h3>
      <button onclick="closeModal()" style="background:none; border:none; color:var(--text); font-size:24px; cursor:pointer">‚úï</button>
    </div>
    <div id="modalBody" style="padding:20px"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ============ TODA LA L√ìGICA ORIGINAL RECUPERADA ============
const currentUser = { name: "Juan P√©rez", balance: 250 };
const trendTags = ["#accidente", "#politica", "#urgente", "#deportes", "#clima"];
let feed = [
  {id:1, title:'Choque M√∫ltiple Panamericana', price:50, lat:-34.6037, lng:-58.3816, img:'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#urgente #transito'},
  {id:2, title:'Gran Incendio en Quilmes', price:150, lat:-34.6070, lng:-58.3772, img:'https://images.unsplash.com/photo-1577962917302-cd874c4e31d2?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#incendio #quilmes'},
  {id:3, title:'Video Exclusivo Rob√≥', price:500, lat:-34.5900, lng:-58.3800, img:'https://images.unsplash.com/photo-1590856029826-c7a73142bbf1?w=800', licenseType:'exclusive', status:'for_sale', hashtags: '#exclusivo #seguridad'}
];

let negotiations = [];
let salesHistory = [{title: 'Corte de Luz', amount: 45, date: '28/12 14:20', img:'https://via.placeholder.com/100'}];
let purchases = [{title: 'Manifestaci√≥n', price: 120, date: '27/12 10:00'}];
let subaccounts = [{name: 'Dron Norte', files: 5}, {name: 'C√°mara 2', files: 12}];

let earningsChart = null;
let activeInterval = null;
const cashSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2012/2012-preview.mp3');

// RENDERIZADO (MARCA DE AGUA MEJORADA)
function generateWatermark() {
  let cells = '';
  for(let i=0; i<9; i++) {
    cells += `<div class="watermark-cell"><span class="wm-brand">Paywall News</span><span class="wm-user">${currentUser.name}</span></div>`;
  }
  return `<div class="watermark-overlay">${cells}</div>`;
}

function renderNews(id, items) {
  const container = document.getElementById(id);
  if(!container) return;
  container.innerHTML = items.map(item => `
    <div class="news-card" onclick="openDetail(${item.id})">
      <div class="news-card-image">
        <img src="${item.img}">
        ${item.status !== 'sold' ? generateWatermark() : ''}
        <div class="price-badge">$${item.price}</div>
        <div class="license-badge ${item.licenseType === 'exclusive' ? 'license-exclusive' : 'license-nonexclusive'}">
            ${item.licenseType === 'exclusive' ? 'üèÜ EXCLUSIVA' : 'üåê COMPARTIDA'}
        </div>
      </div>
      <div style="padding:15px">
        <strong>${item.title}</strong>
        <p style="font-size:12px; color:var(--info); margin:5px 0">${item.hashtags}</p>
        <small>${item.status === 'for_sale' ? 'üü¢ Disponible' : 'üü° Negociando'}</small>
      </div>
    </div>`).join('');
}

// LOGICA DE NEGOCIACI√ìN ORIGINAL (CON CONTRAOFERTA Y MONTO MANUAL)
function openDetail(id) {
  const item = feed.find(x => x.id === id);
  document.getElementById('modalTitle').textContent = item.title;
  
  let content = `
    <div style="position:relative; border-radius:12px; overflow:hidden">
        <img src="${item.img}" style="width:100%">
        ${generateWatermark()}
    </div>
    <div style="margin:15px 0"><strong>${item.hashtags}</strong></div>
  `;

  if(item.licenseType === 'exclusive') {
      content += `<button class="btn btn-primary" onclick="buyDirect(${item.id})">Comprar Exclusividad Directa $${item.price}</button>`;
  } else {
      content += `
        <button class="btn btn-primary" onclick="buyDirect(${item.id})">Comprar Licencia Compartida $${item.price}</button>
        <div class="offer-section">
            <h4 style="text-align:center; color:var(--gold); margin-bottom:10px">üíé Iniciar Negociaci√≥n</h4>
            <div class="quick-offers">
                <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*2})"><div>X2</div>$${item.price*2}</div>
                <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*3})"><div>X3</div>$${item.price*3}</div>
                <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*4})"><div>X4</div>$${item.price*4}</div>
            </div>
            <div style="display:flex; gap:10px">
                <input type="number" id="customOffer" placeholder="Monto espec√≠fico..." style="flex:1; padding:12px; border-radius:10px; background:var(--bg); border:1px solid var(--border); color:white">
                <button class="btn btn-gold" style="width:auto" onclick="sendCustomOffer(${item.id})">Enviar</button>
            </div>
        </div>
      `;
  }
  document.getElementById('modalBody').innerHTML = content;
  document.getElementById('modal').classList.add('active');
}

// PANEL DE VENDEDOR CON CONTRAOFERTA
function showSellerPanel(negId) {
  const neg = negotiations.find(n => n.id === negId);
  const item = feed.find(f => f.id === neg.newsId);
  document.getElementById('modalTitle').textContent = 'Oferta Recibida';
  document.getElementById('modalBody').innerHTML = `
    <div class="timer-box">
        <small>TIEMPO RESTANTE</small>
        <div id="countdown" class="timer-countdown">15:00</div>
    </div>
    <div style="text-align:center; padding:20px; background:var(--bg); border-radius:15px; margin-bottom:15px">
        <h1 style="color:var(--gold)">$${neg.amount}</h1>
        <p>${item.title}</p>
    </div>
    <button class="btn btn-primary" onclick="acceptOffer(${negId})">ACEPTAR OFERTA</button>
    <div style="margin-top:15px">
        <input type="number" id="counterAmount" placeholder="Enviar contraoferta..." style="width:100%; padding:12px; border-radius:10px; background:var(--bg); border:1px solid var(--border); color:white">
        <button class="btn btn-gold" style="margin-top:10px" onclick="sendCounter(${negId})">ENVIAR CONTRAOFERTA</button>
    </div>
  `;
  document.getElementById('modal').classList.add('active');
  startCountdown(negId);
}

// LOGICA DE GR√ÅFICO (Eje X din√°mico)
function initChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    earningsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'],
            datasets: [{ data: [50, 80, 45, 120, 100, 190, 70], backgroundColor: '#ff3b30', borderRadius: 4 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }
        }
    });
}

function updateChart(period, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if(period === 'week') { earningsChart.data.labels = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom']; earningsChart.data.datasets[0].data = [50,80,45,120,100,190,70]; }
    else if(period === 'month') { earningsChart.data.labels = ['Sem 1','Sem 2','Sem 3','Sem 4']; earningsChart.data.datasets[0].data = [400, 750, 500, 900]; }
    else { earningsChart.data.labels = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']; earningsChart.data.datasets[0].data = [1200, 1500, 1100, 1800, 2000, 2500, 1900, 2200, 2400, 2800, 2600, 3500]; }
    earningsChart.update();
}

// VISTAS RECUPERADAS
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById(`view-${name}`).style.display = 'block';
  
  if(name === 'sales') { renderSales(); if(!earningsChart) initChart(); }
  if(name === 'discover') { renderNews('discoverGrid', feed); renderHashtags(); }
  if(name === 'upload') renderUploadTrends();
}

function renderSales() {
    const pending = negotiations.filter(n => n.status === 'pending');
    document.getElementById('pendingOffersCard').style.display = pending.length ? 'block' : 'none';
    document.getElementById('offersList').innerHTML = pending.map(n => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:15px; border-radius:12px; margin-bottom:10px">
            <div><strong>$${n.amount}</strong><br><small>Oferta Recibida</small></div>
            <button class="btn btn-primary" style="width:auto" onclick="showSellerPanel(${n.id})">Gestionar</button>
        </div>`).join('');

    document.getElementById('salesList').innerHTML = salesHistory.map(s => `
        <div style="display:flex; gap:12px; align-items:center; padding:10px; border-bottom:1px solid var(--border)">
            <img src="${s.img}" style="width:60px; height:45px; border-radius:6px; object-fit:cover">
            <div style="flex:1"><strong>${s.title}</strong><br><small>${s.date}</small></div>
            <strong style="color:var(--success)">+$${s.amount}</strong>
        </div>`).join('');
    
    document.getElementById('purchasesList').innerHTML = purchases.map(p => `
        <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border)">
            <div><strong>${p.title}</strong><br><small>${p.date}</small></div>
            <strong style="color:var(--accent)">-$${p.price}</strong>
        </div>`).join('');
}

function renderHashtags() {
    document.getElementById('trendingHashtags').innerHTML = trendTags.map(t => `<span style="display:inline-block; background:rgba(255,59,48,0.1); padding:6px 15px; border-radius:20px; color:var(--accent); margin-right:10px; cursor:pointer" onclick="filterHash('${t}')">${t}</span>`).join('');
}

function renderUploadTrends() {
    document.getElementById('uploadTrendTags').innerHTML = trendTags.slice(0,3).join(", ");
}

function selectLic(el, type) {
    document.querySelectorAll('.license-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('licenseInput').value = type;
}

// AUXILIARES
function makeOffer(itemId, amount) {
    const expiresAt = Date.now() + (15 * 60 * 1000);
    negotiations.push({ id: negotiations.length+1, newsId: itemId, amount, status: 'pending', expiresAt });
    feed.find(x => x.id === itemId).status = 'negotiating';
    document.getElementById('navNotif').classList.add('active');
    closeModal(); renderNews('homeGrid', feed);
}

function sendCustomOffer(itemId) {
    const val = Number(document.getElementById('customOffer').value);
    if(val > 0) makeOffer(itemId, val);
}

function acceptOffer(id) {
    const neg = negotiations.find(n => n.id === id);
    const item = feed.find(f => f.id === neg.newsId);
    cashSound.play().catch(()=>{});
    item.status = 'sold';
    neg.status = 'accepted';
    salesHistory.unshift({title: item.title, amount: neg.amount, date: new Date().toLocaleDateString(), img: item.img});
    document.getElementById('navNotif').classList.remove('active');
    closeModal(); renderNews('homeGrid', feed);
}

function startCountdown(negId) {
    if(activeInterval) clearInterval(activeInterval);
    activeInterval = setInterval(() => {
        const neg = negotiations.find(n => n.id === negId);
        const diff = neg.expiresAt - Date.now();
        if(diff <= 0) { clearInterval(activeInterval); closeModal(); return; }
        const mins = Math.floor(diff/60000);
        const secs = Math.floor((diff%60000)/1000);
        const el = document.getElementById('countdown');
        if(el) el.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
}

function closeModal() { document.getElementById('modal').classList.remove('active'); clearInterval(activeInterval); }

// INIT
let map = L.map('map', {zoomControl: false}).setView([-34.6037, -58.3816], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
renderNews('homeGrid', feed);
document.getElementById('themeToggle').onclick = () => document.body.classList.toggle('light');
</script>
</body>
</html>