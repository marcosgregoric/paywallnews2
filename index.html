<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paywall News | Red Global de Periodismo Ciudadano</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --accent: #ff3b30;
            --gold: #ffd700;
            --bg: #0b0b0d;
            --bg-soft: #1c1c1e;
            --text: #ffffff;
            --text-dim: #8e8e93;
            --border: rgba(255,255,255,0.1);
            --success: #34c759;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 80px; }

        /* HEADER & BILLETERA */
        header { 
            padding: 15px 20px; background: rgba(11, 11, 13, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }
        .user-badge { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .badge-icon { color: var(--gold); }

        .container { padding: 15px; max-width: 800px; margin: 0 auto; }

        /* MAPA & FILTROS */
        #map-wrapper { 
            width: 100%; height: 350px; border-radius: 20px; overflow: hidden; 
            margin-bottom: 15px; border: 1px solid var(--border); position: relative;
        }
        #map { height: 100%; width: 100%; }
        .map-filters { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px;
            scrollbar-width: none;
        }
        .filter-btn { 
            padding: 8px 16px; border-radius: 20px; background: var(--bg-soft); 
            border: 1px solid var(--border); color: var(--text-dim); white-space: nowrap; cursor: pointer;
        }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* NEWS CARDS */
        .news-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .news-card { background: var(--bg-soft); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); transition: 0.3s; }
        .news-card:active { transform: scale(0.98); }
        .news-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .card-content { padding: 12px; }
        .card-tag { font-size: 10px; font-weight: bold; text-transform: uppercase; color: var(--accent); margin-bottom: 4px; display: block; }
        .card-price { color: var(--gold); font-weight: bold; font-size: 16px; }

        /* VISTAS */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BOTONES & UI */
        .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--bg-soft); color: white; border: 1px solid var(--border); }
        
        /* FORMULARIO DE SUBIDA */
        .drop-zone {
            width: 100%; height: 200px; border: 2px dashed var(--border); border-radius: 20px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            margin-bottom: 20px; cursor: pointer; overflow: hidden;
        }
        .drop-zone img { width: 100%; height: 100%; object-fit: cover; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: var(--text-dim); font-size: 12px; margin-bottom: 6px; }
        .input-field { width: 100%; padding: 15px; border-radius: 12px; background: var(--bg-soft); border: 1px solid var(--border); color: white; outline: none; }

        /* CHAT */
        .chat-container { height: 300px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 15px; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; }
        .msg.buyer { background: var(--bg-soft); align-self: flex-start; }
        .msg.seller { background: var(--accent); color: white; margin-left: auto; }

        /* NAV BAR */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(28,28,30,0.95);
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 1000;
        }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }

        /* MODALES */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; 
            display: none; align-items: flex-end; 
        }
        .modal-overlay.active { display: flex; }
        .modal-sheet { 
            background: var(--bg-soft); width: 100%; border-radius: 30px 30px 0 0; 
            padding: 30px 20px; max-height: 90vh; overflow-y: auto;
        }
    </style>
</head>
<body class="cronista-mode">
  <header>
        <div class="user-badge" id="user-identity">
            <span id="role-icon">üë§</span>
            <div>
                <strong id="display-role">Cronista Ciudadano</strong><br>
                <small style="color:var(--text-dim)" id="display-status">Verificado ‚úì</small>
            </div>
        </div>
        <div style="text-align: right;">
            <span style="color:var(--gold); font-weight:bold; font-size:1.2rem;" id="wallet-val">$0.00</span>
        </div>
    </header>

    <div class="container">
        <section id="view-home" class="view active">
            <div id="map-wrapper"><div id="map"></div></div>
            <div class="map-filters">
                <div class="filter-btn active" onclick="filterBy('all')">Todos</div>
                <div class="filter-btn" onclick="filterBy('Urgente')">üö® Urgente</div>
                <div class="filter-btn" onclick="filterBy('Clima')">‚õàÔ∏è Clima</div>
                <div class="filter-btn" onclick="filterBy('Social')">üì¢ Social</div>
                <div class="filter-btn" onclick="filterBy('Tr√°nsito')">üöó Tr√°nsito</div>
            </div>
            <h3 style="margin-bottom:15px">Noticias en tu √°rea</h3>
            <div class="news-grid" id="main-feed"></div>
        </section>

        <section id="view-upload" class="view">
            <h3>Reportar Noticia</h3>
            <p style="color:var(--text-dim); font-size:14px; margin:10px 0 20px;">Tu ubicaci√≥n se grabar√° autom√°ticamente para validar el reporte.</p>
            
            <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-ptr').click()">
                <div id="drop-text">
                    <span style="font-size:40px;">üì∏</span><br>
                    <strong>Subir Foto o Video</strong>
                </div>
                <img id="upload-preview" style="display:none;">
            </div>
            <input type="file" id="file-ptr" accept="image/*,video/*" style="display:none;" onchange="handleFile(event)">

            <div class="input-group">
                <label>T√çTULO DEL HECHO</label>
                <input type="text" id="up-title" class="input-field" placeholder="Ej: Choque m√∫ltiple en Av. Central">
            </div>

            <div class="input-group">
                <label>CATEGOR√çA</label>
                <select id="up-cat" class="input-field">
                    <option value="Urgente">üö® Urgente</option>
                    <option value="Clima">‚õàÔ∏è Clima</option>
                    <option value="Social">üì¢ Social</option>
                    <option value="Tr√°nsito">üöó Tr√°nsito</option>
                </select>
            </div>

            <div class="input-group">
                <label>PRECIO SUGERIDO (USD)</label>
                <input type="number" id="up-price" class="input-field" placeholder="0.00">
            </div>

            <button class="btn btn-primary" onclick="processUpload()">Publicar en el Mapa</button>
        </section>

        <section id="view-profile" class="view">
            <div style="background:var(--bg-soft); padding:20px; border-radius:20px; margin-bottom:20px; border:1px solid var(--gold);">
                <small style="color:var(--text-dim)">CONTROL DE FONDOS</small>
                <h2 id="wallet-big" style="color:var(--gold); font-size:2rem; margin:10px 0;">$0.00</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" style="padding:10px; font-size:12px;">Retirar a PayPal/Bank</button>
                    <button class="btn btn-secondary" style="padding:10px; font-size:12px;" onclick="switchRole()">Cambiar a Medio</button>
                </div>
            </div>

            <h3>Mis Publicaciones</h3>
            <div id="user-posts" style="margin-top:15px;"></div>
        </section>
    </div>

    <div class="modal-overlay" id="modal-news">
        <div class="modal-sheet">
            <div id="modal-body"></div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="navTo('home', this)"><i>üìç</i>Mapa</div>
        <div class="nav-item" onclick="navTo('upload', this)"><i>üì∏</i>Reportar</div>
        <div class="nav-item" onclick="navTo('profile', this)"><i>üí∞</i>Cartera</div>
    </nav>

    <script>
        // ESTADO GLOBAL
        let state = {
            wallet: parseFloat(localStorage.getItem('pn_wallet')) || 0,
            role: localStorage.getItem('pn_role') || 'cronista',
            news: JSON.parse(localStorage.getItem('pn_news')) || [
                {id:1, title:"Inundaci√≥n en Calle 5", price:50, cat:"Clima", lat:-34.6037, lng:-58.3816, img:"https://picsum.photos/400/225?random=5", sold:false},
                {id:2, title:"Manifestaci√≥n pac√≠fica", price:35, cat:"Social", lat:-34.610, lng:-58.390, img:"https://picsum.photos/400/225?random=8", sold:false}
            ],
            tempImg: null
        };

        let map;
        let markers = [];

        // INICIALIZACI√ìN
        window.onload = () => {
            updateUI();
            initMap();
            renderFeed(state.news);
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([-34.6037, -58.3816], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            refreshMarkers(state.news);
        }

        function refreshMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            data.filter(n => !n.sold).forEach(n => {
                let m = L.circleMarker([n.lat, n.lng], {
                    radius: 10, fillColor: "#ff3b30", color: "#fff", weight: 2, fillOpacity: 1
                }).addTo(map);
                m.on('click', () => openNews(n.id));
                markers.push(m);
            });
        }

        // L√ìGICA DE ARCHIVOS
        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                state.tempImg = event.target.result;
                document.getElementById('upload-preview').src = state.tempImg;
                document.getElementById('upload-preview').style.display = 'block';
                document.getElementById('drop-text').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // PUBLICAR
        function processUpload() {
            const title = document.getElementById('up-title').value;
            const price = document.getElementById('up-price').value;
            const cat = document.getElementById('up-cat').value;

            if(!title || !price || !state.tempImg) return alert("Faltan datos o imagen");

            const newItem = {
                id: Date.now(),
                title: title,
                price: parseFloat(price),
                cat: cat,
                lat: map.getCenter().lat + (Math.random() * 0.01),
                lng: map.getCenter().lng + (Math.random() * 0.01),
                img: state.tempImg,
                sold: false
            };

            state.news.unshift(newItem);
            save();
            alert("Noticia publicada exitosamente.");
            location.reload(); // Refrescar para limpiar formulario y mapa
        }

        // COMPRA Y NEGOCIACI√ìN
        function openNews(id) {
            const n = state.news.find(x => x.id === id);
            const overlay = document.getElementById('modal-news');
            document.getElementById('modal-body').innerHTML = `
                <img src="${n.img}" style="width:100%; border-radius:15px; margin-bottom:15px;">
                <span class="card-tag">${n.cat}</span>
                <h2 style="margin-bottom:10px;">${n.title}</h2>
                <p style="color:var(--text-dim); font-size:14px; margin-bottom:20px;">Publicado por Cronista Verificado</p>
                
                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:15px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Licencia Exclusiva</span>
                        <strong style="color:var(--gold)">$${n.price}</strong>
                    </div>
                    <p style="font-size:11px; color:var(--text-dim);">La compra elimina este registro del mapa p√∫blico para otros medios.</p>
                </div>

                <div class="chat-container" id="chat-box">
                    <div class="msg buyer">Sistema: Abre un chat para negociar el precio con el cronista.</div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="buyItem(${n.id}, ${n.price})">Comprar ahora</button>
                    <button class="btn btn-secondary" onclick="offerChat()">Negociar</button>
                </div>
                <button class="btn" style="background:transparent; color:var(--text-dim)" onclick="closeModal()">Cerrar</button>
            `;
            overlay.classList.add('active');
        }

        function buyItem(id, price) {
            if(confirm("¬øConfirmas la compra exclusiva por $" + price + "?")) {
                const n = state.news.find(x => x.id === id);
                n.sold = true;
                state.wallet += price;
                save();
                alert("Compra exitosa. El contenido ha sido descargado y removido del mapa p√∫blico.");
                location.reload();
            }
        }

        function offerChat() {
            const box = document.getElementById('chat-box');
            const p = prompt("Escribe tu oferta o mensaje para el cronista:");
            if(p) {
                box.innerHTML += `<div class="msg buyer">${p}</div>`;
                box.innerHTML += `<div class="msg seller">Cronista: He recibido tu oferta de negociaci√≥n. Mantente en l√≠nea.</div>`;
            }
        }

        // UTILIDADES
        function navTo(view, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-'+view).classList.add('active');
            el.classList.add('active');
            if(view === 'home' && map) setTimeout(() => map.invalidateSize(), 200);
            if(view === 'profile') renderUserPosts();
        }

        function renderFeed(data) {
            const feed = document.getElementById('main-feed');
            feed.innerHTML = data.filter(n => !n.sold).map(n => `
                <div class="news-card" onclick="openNews(${n.id})">
                    <img src="${n.img}">
                    <div class="card-content">
                        <span class="card-tag">${n.cat}</span>
                        <p style="font-size:14px; font-weight:bold; margin-bottom:5px;">${n.title}</p>
                        <span class="card-price">$${n.price}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderUserPosts() {
            const cont = document.getElementById('user-posts');
            const myPosts = state.news;
            cont.innerHTML = myPosts.map(n => `
                <div style="display:flex; gap:10px; background:var(--bg-soft); padding:10px; border-radius:12px; margin-bottom:10px; border-left:4px solid ${n.sold ? 'var(--success)' : 'var(--gold)'}">
                    <img src="${n.img}" style="width:60px; height:60px; border-radius:8px; object-fit:cover;">
                    <div>
                        <p style="font-size:13px; font-weight:bold;">${n.title}</p>
                        <small style="color:${n.sold ? 'var(--success)' : 'var(--text-dim)'}">${n.sold ? 'VENDIDO' : 'EN VENTA'}</small>
                    </div>
                </div>
            `).join('');
        }

        function filterBy(cat) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            const filtered = cat === 'all' ? state.news : state.news.filter(n => n.cat === cat);
            renderFeed(filtered);
            refreshMarkers(filtered);
        }

        function switchRole() {
            state.role = state.role === 'cronista' ? 'medio' : 'cronista';
            localStorage.setItem('pn_role', state.role);
            location.reload();
        }

        function updateUI() {
            document.getElementById('wallet-val').innerText = `$${state.wallet.toFixed(2)}`;
            document.getElementById('wallet-big').innerText = `$${state.wallet.toFixed(2)}`;
            if(state.role === 'medio') {
                document.getElementById('display-role').innerText = "Medio de Comunicaci√≥n";
                document.getElementById('role-icon').innerText = "üì∫";
                document.querySelector('.nav-item[onclick*="upload"]').style.display = "none";
            }
        }

        function save() {
            localStorage.setItem('pn_news', JSON.stringify(state.news));
            localStorage.setItem('pn_wallet', state.wallet.toString());
        }

        function closeModal() { document.getElementById('modal-news').classList.remove('active'); }
    </script>
</body>
</html>
