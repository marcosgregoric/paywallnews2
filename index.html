<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paywall News - Marketplace Profesional</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ============ TU SISTEMA DE VARIABLES COMPLETO ============ */
        :root {
            --accent: #ff3b30;
            --accent-hover: #e6342a;
            --success: #4cd964;
            --warning: #ffcc00;
            --info: #007aff;
            --gold: #ffd700;
        }

        body.light {
            --bg: #f2f2f7;
            --bg-secondary: #ffffff;
            --card: #ffffff;
            --text: #1c1c1e;
            --text-secondary: #8e8e93;
            --border: rgba(0,0,0,0.1);
            --shadow: rgba(0,0,0,0.05);
            --overlay: rgba(255,255,255,0.8);
            --map-style: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        }

        body.dark {
            --bg: #000000;
            --bg-secondary: #1c1c1e;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-secondary: #8e8e93;
            --border: rgba(255,255,255,0.1);
            --shadow: rgba(0,0,0,0.5);
            --overlay: rgba(0,0,0,0.8);
            --map-style: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        }

        /* ============ TU EST√âTICA ORIGINAL ============ */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        
        /* HEADER */
        header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); sticky; top: 0; z-index: 1000; }
        
        /* MAPA */
        .map-container { height: 350px; border-radius: 20px; overflow: hidden; margin-bottom: 25px; border: 1px solid var(--border); position: relative; }
        #map { height: 100%; width: 100%; }

        /* GRID DE NOTICIAS */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .news-card { background: var(--card); border-radius: 18px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; transition: 0.3s; }
        .news-card:hover { transform: translateY(-5px); }
        .news-card-image { position: relative; aspect-ratio: 16/9; }
        .news-card-image img { width: 100%; height: 100%; object-fit: cover; }
        
        /* BADGES */
        .license-badge { position: absolute; top: 12px; left: 12px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; }
        .license-exclusive { background: var(--gold); color: #000; }
        .license-nonexclusive { background: var(--info); color: #fff; }
        .license-geo { background: var(--success); color: #fff; }
        
        /* MODAL Y NEGOCIACI√ìN */
        .modal { position: fixed; inset: 0; background: var(--overlay); backdrop-filter: blur(15px); display: none; z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); width: 90%; max-width: 600px; border-radius: 30px; max-height: 90vh; overflow-y: auto; padding: 25px; }
        
        .offer-section { background: var(--bg); border: 2px solid var(--gold); border-radius: 20px; padding: 20px; margin-top: 20px; }
        .quick-offers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .quick-offer-btn { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; }
        
        .input-group { display: flex; gap: 10px; margin-top: 15px; }
        .form-input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        
        /* NAV */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--card); border: 1px solid var(--border); padding: 10px 30px; border-radius: 40px; display: flex; gap: 40px; box-shadow: 0 10px 30px var(--shadow); z-index: 1000; }
        .nav-item { cursor: pointer; font-size: 20px; opacity: 0.5; transition: 0.3s; }
        .nav-item.active { opacity: 1; transform: scale(1.2); }

        .view { display: none; }
        .view.active { display: block; }

        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .status-for-sale { background: rgba(76, 217, 100, 0.2); color: var(--success); }
        .status-negotiating { background: rgba(255, 204, 0, 0.2); color: var(--warning); }
        .status-sold { background: rgba(142, 142, 147, 0.2); color: var(--text-secondary); }
    </style>
</head>
<body class="dark">

<header>
    <div style="font-weight: 900; font-size: 20px;">PAYWALL <span style="color: var(--accent);">NEWS</span></div>
    <div style="display: flex; gap: 15px;">
        <button id="themeToggle" style="background:none; border:none; font-size: 20px; cursor:pointer;">üåû</button>
        <div style="font-size: 20px; cursor:pointer;" onclick="showView('profile')">üë§</div>
    </div>
</header>

<div class="container">
    <div id="view-home" class="view active">
        <div class="map-container"><div id="map"></div></div>
        <h2 style="margin-bottom: 20px;">Tendencias üî•</h2>
        <div class="news-grid" id="homeGrid"></div>
    </div>

    <div id="view-discover" class="view">
        <div style="margin-bottom: 25px;">
            <input type="text" id="searchInput" class="form-input" placeholder="Buscar por #hashtag o t√≠tulo...">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <select id="filterLicense" class="form-input">
                    <option value="">Todas las licencias</option>
                    <option value="exclusive">Exclusiva</option>
                    <option value="nonexclusive">No Exclusiva</option>
                    <option value="geo">Geogr√°fica</option>
                </select>
                <select id="filterImportance" class="form-input">
                    <option value="">Importancia</option>
                    <option value="high">Alta üî•</option>
                    <option value="medium">Media ‚ö°</option>
                    <option value="low">Baja üìç</option>
                </select>
            </div>
        </div>
        <div class="news-grid" id="discoverGrid"></div>
        <div id="noResults" style="display:none; text-align:center; padding:50px;">No hay resultados para tu b√∫squeda</div>
    </div>

    <div id="view-upload" class="view">
        <h2 style="margin-bottom:20px">Subir Material</h2>
        <form id="uploadForm" style="background: var(--card); padding: 25px; border-radius: 20px;">
            <div class="form-group" style="margin-bottom:15px">
                <label>T√≠tulo de la noticia</label>
                <input type="text" id="titleInput" class="form-input" required>
            </div>
            <div class="form-group" style="margin-bottom:15px">
                <label>Hashtags (separados por espacio)</label>
                <div id="trendingSuggestions" style="margin: 10px 0;"></div>
                <input type="text" id="hashtagsInput" class="form-input" placeholder="#accidente #urgente">
            </div>
            <div class="form-group" style="margin-bottom:15px">
                <label>Precio Base (USD)</label>
                <input type="number" id="priceInput" class="form-input" required>
            </div>
            <div class="form-group">
                <label>Tipo de Licencia Inicial</label>
                <div class="license-option" data-license="nonexclusive">üåê No Exclusiva</div>
                <div class="license-option" data-license="exclusive">üèÜ Exclusiva</div>
                <div class="license-option" data-license="geo">üó∫Ô∏è Geogr√°fica</div>
                <input type="hidden" id="licenseInput" value="nonexclusive">
            </div>
            <button type="submit" class="quick-offer-btn" style="width:100%; margin-top:20px; background:var(--accent); color:white; font-weight:bold;">SUBIR CONTENIDO</button>
        </form>
    </div>

    <div id="view-sales" class="view">
        <div id="pendingOffersCard" class="offer-section" style="display:none;">
            <h3>üîî Ofertas entrantes</h3>
            <div id="offersList"></div>
        </div>
        <h2 style="margin: 20px 0;">Mis Publicaciones</h2>
        <div id="salesList"></div>
        <h2 style="margin: 20px 0;">Mis Compras</h2>
        <div id="purchasesList"></div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="showView('home')">üè†</div>
    <div class="nav-item" onclick="showView('discover')">üîç</div>
    <div class="nav-item" onclick="showView('upload')">üì§</div>
    <div class="nav-item" onclick="showView('sales')">üìä</div>
</nav>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="modalTitle"></h3>
            <span onclick="closeModal()" style="cursor:pointer; font-size:24px;">‚úï</span>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
// ============ DATOS CARGADOS (RESTAURADOS) ============
const feed = [
  {id:1,title:'Accidente en Av. Mitre',price:50,lat:-34.6037,lng:-58.3816,importance:'high',img:'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800',licenseType:'nonexclusive',status:'for_sale',hashtags:'#accidente #tr√°nsito',trending:true},
  {id:2,title:'Manifestaci√≥n frente al Congreso',price:120,lat:-34.6070,lng:-58.3772,importance:'medium',img:'https://images.unsplash.com/photo-1590856029826-c7a73142bbf1?w=800',licenseType:'exclusive',status:'for_sale',hashtags:'#manifestacion #pol√≠tica',trending:true},
  {id:3,title:'Incendio en pol√≠gono industrial',price:80,lat:-34.6000,lng:-58.3900,importance:'low',img:'https://images.unsplash.com/photo-1577962917302-cd874c4e31d2?w=800',licenseType:'nonexclusive',status:'in_review',hashtags:'#incendio #industria',trending:false},
  {id:4,title:'Corte en Ruta 9 por protesta',price:70,lat:-34.6050,lng:-58.3920,importance:'medium',img:'https://images.unsplash.com/photo-1558882224-dda166733046?w=800',licenseType:'geo',status:'sold',hashtags:'#ruta9 #protesta',trending:false},
  {id:5,title:'Fuga de gas en barrio sur',price:95,lat:-34.6080,lng:-58.3890,importance:'high',img:'https://images.unsplash.com/photo-1562690868-60bbe7293e94?w=800',licenseType:'nonexclusive',status:'for_sale',hashtags:'#gas #emergencia',trending:true}
];

const trendingHashtags = ['#accidente', '#manifestacion', '#gas', '#emergencia', '#tr√°nsito'];
const purchases = [{id:101,title:'Accidente en Av. Mitre',price:50,date:'2025-06-10'}];
let negotiations = [];
let map = null;
let currentTileLayer = null;

// ============ L√ìGICA DE MAPA DIN√ÅMICO ============
function initMap() {
    if (map) return;
    map = L.map('map').setView([-34.6037, -58.3816], 13);
    updateMapTheme();

    feed.forEach(item => {
        const color = item.importance === 'high' ? '#ff3b30' : (item.importance === 'medium' ? '#ffcc00' : '#4cd964');
        const icon = L.divIcon({
            className: '',
            html: `<div style="width:20px;height:20px;background:${color};border:3px solid white;border-radius:50%;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>`
        });
        L.marker([item.lat, item.lng], {icon}).addTo(map).on('click', () => openDetail(item.id));
    });
}

function updateMapTheme() {
    const isDark = document.body.classList.contains('dark');
    const style = isDark ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    if (currentTileLayer) map.removeLayer(currentTileLayer);
    currentTileLayer = L.tileLayer(style, { attribution: '¬© OS' }).addTo(map);
}

// ============ TEMA ============
document.getElementById('themeToggle').onclick = () => {
    document.body.classList.toggle('light');
    document.body.classList.toggle('dark');
    const newTheme = document.body.classList.contains('light') ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'üåû' : 'üåô';
    if (map) updateMapTheme();
};

// ============ RENDERIZADO DE NOTICIAS ============
function getLicenseBadge(type) {
    if (type === 'exclusive') return '<div class="license-badge license-exclusive">üèÜ EXCLUSIVA</div>';
    if (type === 'geo') return '<div class="license-badge license-geo">üó∫Ô∏è GEO</div>';
    return '<div class="license-badge license-nonexclusive">üåê COMPARTIDA</div>';
}

function getStatusBadge(status) {
    if (status === 'for_sale') return '<span class="status-badge status-for-sale">En venta</span>';
    if (status === 'negotiating') return '<span class="status-badge status-negotiating">En negociaci√≥n</span>';
    return '<span class="status-badge status-sold">Vendida</span>';
}

function renderNewsCard(item) {
    return `
        <div class="news-card" onclick="openDetail(${item.id})">
            <div class="news-card-image">
                <img src="${item.img}">
                ${getLicenseBadge(item.licenseType)}
                <div style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:5px 10px; border-radius:8px; font-weight:bold;">$${item.price}</div>
            </div>
            <div style="padding:15px;">
                <div style="font-weight:bold; margin-bottom:10px;">${item.title}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${getStatusBadge(item.status)}
                    <span style="font-size:12px; color:var(--info);">${item.hashtags.split(' ')[0]}</span>
                </div>
            </div>
        </div>`;
}

// ============ SISTEMA DE NEGOCIACI√ìN (COMPLETO) ============
function openDetail(itemId) {
    const item = feed.find(x => x.id === itemId);
    if (!item) return;

    let actionContent = '';
    if (item.status === 'for_sale') {
        actionContent = `
            <button class="quick-offer-btn" onclick="buyNow(${item.id})" style="width:100%; background:var(--accent); color:white; border:none; margin-bottom:15px;">üí≥ COMPRAR LICENCIA - $${item.price}</button>
            <div class="offer-section">
                <h4 style="text-align:center; color:var(--gold);">üíé Solicitar Exclusividad</h4>
                <div class="quick-offers">
                    <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price * 2})">x2 ($${item.price * 2})</div>
                    <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price * 3})">x3 ($${item.price * 3})</div>
                    <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price * 4})">x4 ($${item.price * 4})</div>
                </div>
                <div class="input-group">
                    <input type="number" id="customOffer${item.id}" class="form-input" placeholder="Tu oferta...">
                    <button class="quick-offer-btn" onclick="makeCustomOffer(${item.id})" style="background:var(--gold); color:black;">Enviar</button>
                </div>
            </div>
        `;
    } else {
        actionContent = `<div style="text-align:center; padding:20px; opacity:0.6;">Este contenido no est√° disponible para nuevas ofertas.</div>`;
    }

    document.getElementById('modalTitle').textContent = item.title;
    document.getElementById('modalBody').innerHTML = `
        <img src="${item.img}" style="width:100%; border-radius:15px; margin-bottom:20px;">
        <div style="margin-bottom:20px;">
            <p style="color:var(--text-secondary); line-height:1.5;">Material informativo verificado de importancia ${item.importance}. Licencia original: ${item.licenseType}.</p>
        </div>
        ${actionContent}
    `;
    document.getElementById('modal').classList.add('active');
}

function makeOffer(itemId, amount) {
    const item = feed.find(x => x.id === itemId);
    const negId = negotiations.length + 1;
    negotiations.push({ id: negId, newsId: itemId, amount, status: 'pending', buyer: 'Medio X', round: 1 });
    item.status = 'negotiating';
    alert("Oferta de $" + amount + " enviada. El vendedor tiene 15 min.");
    closeModal();
    renderAllViews();
}

function makeCustomOffer(itemId) {
    const val = document.getElementById('customOffer' + itemId).value;
    if (val) makeOffer(itemId, Number(val));
}

// ============ NAVEGACI√ìN Y FILTROS ============
function showView(viewName) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`view-${viewName}`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    if (viewName === 'home') initMap();
    if (viewName === 'discover') filterNews();
    if (viewName === 'sales') renderSales();
}

function filterNews() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const license = document.getElementById('filterLicense').value;
    const importance = document.getElementById('filterImportance').value;

    const filtered = feed.filter(item => {
        const matchSearch = item.title.toLowerCase().includes(search) || item.hashtags.toLowerCase().includes(search);
        const matchLicense = !license || item.licenseType === license;
        const matchImportance = !importance || item.importance === importance;
        return matchSearch && matchLicense && matchImportance;
    });

    document.getElementById('discoverGrid').innerHTML = filtered.map(item => renderNewsCard(item)).join('');
    document.getElementById('noResults').style.display = filtered.length ? 'none' : 'block';
}

// ============ MIS NOTICIAS ============
function renderSales() {
    const pending = negotiations.filter(n => n.status === 'pending');
    const container = document.getElementById('offersList');
    
    if (pending.length) {
        document.getElementById('pendingOffersCard').style.display = 'block';
        container.innerHTML = pending.map(n => {
            const item = feed.find(f => f.id === n.newsId);
            return `<div style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:15px; border-radius:12px; margin-bottom:10px;">
                <div><b>$${n.amount}</b> por ${item.title}</div>
                <button onclick="acceptOffer(${n.id})" style="background:var(--success); color:white; border:none; padding:8px 12px; border-radius:8px;">Aceptar</button>
            </div>`;
        }).join('');
    } else {
        document.getElementById('pendingOffersCard').style.display = 'none';
    }

    document.getElementById('salesList').innerHTML = feed.slice(0,3).map(item => `
        <div style="display:flex; gap:15px; background:var(--card); padding:10px; border-radius:12px; margin-bottom:10px;">
            <img src="${item.img}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
            <div style="flex:1">
                <div style="font-weight:bold;">${item.title}</div>
                <div style="font-size:12px; color:var(--text-secondary);">${getStatusBadge(item.status)}</div>
            </div>
            <div style="font-weight:bold;">$${item.price}</div>
        </div>
    `).join('');
}

function acceptOffer(id) {
    const neg = negotiations.find(n => n.id === id);
    const item = feed.find(f => f.id === neg.newsId);
    item.status = 'sold';
    neg.status = 'accepted';
    alert("¬°Contenido vendido!");
    renderSales();
}

function closeModal() { document.getElementById('modal').classList.remove('active'); }

function renderAllViews() {
    document.getElementById('homeGrid').innerHTML = feed.map(item => renderNewsCard(item)).join('');
    filterNews();
}

// ============ INIT ============
window.onload = () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') document.body.classList.replace('dark', 'light');
    renderAllViews();
    initMap();
};

document.getElementById('searchInput').oninput = filterNews;
document.getElementById('filterLicense').onchange = filterNews;
document.getElementById('filterImportance').onchange = filterNews;
</script>
</body>
</html>
