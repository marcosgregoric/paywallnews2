<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsMarket - Sistema Integrado v3</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --accent: #ff3b30;
            --primary: #007aff;
            --secondary: #8e8e93;
            --success: #4cd964;
            --border: #d2d2d7;
        }

        .dark {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #f5f5f7;
            --secondary: #48484a;
            --border: #38383a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 80px;
            transition: background 0.3s ease;
        }

        .app-container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* HEADER & BALANCE */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .balance-card {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }

        /* MAPA */
        #map-container {
            position: relative;
            height: 350px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        #map { height: 100%; width: 100%; z-index: 1; }
        .gps-btn {
            position: absolute; bottom: 15px; right: 15px; z-index: 1000;
            background: white; border: none; width: 45px; height: 45px;
            border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer;
        }

        /* GRID DE NOTICIAS */
        .news-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .news-card {
            background: var(--card); border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative;
        }
        .news-card img { width: 100%; height: 100px; object-fit: cover; transition: 0.3s; }
        .blur { filter: blur(4px); }
        .card-body { padding: 10px; }
        .price-badge {
            position: absolute; top: 8px; right: 8px; background: var(--accent);
            color: white; padding: 2px 6px; border-radius: 5px; font-weight: bold; font-size: 12px;
        }

        /* LISTADO DE TRANSACCIONES */
        .tx-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: var(--card); border-radius: 10px;
            margin-bottom: 10px; border-left: 4px solid var(--success);
        }

        /* NAVEGACIN */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card); display: flex; justify-content: space-around;
            padding: 15px 0; border-top: 1px solid var(--border); z-index: 2000;
        }
        .nav-item { color: var(--secondary); font-size: 10px; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* MODAL */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center;
        }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-buy { background: var(--primary); color: white; }

        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body class="light">

<div class="app-container">
    <header>
        <h2 style="margin:0">NewsMarket</h2>
        <button id="themeToggle" style="background:none; border:none; font-size:20px; cursor:pointer;"></button>
    </header>

    <div id="view-home" class="view active">
        <div id="map-container">
            <div id="map"></div>
            <button class="gps-btn" onclick="locateUser()"></button>
        </div>
        <h3>Cerca de ti</h3>
        <div id="newsFeed" class="news-grid"></div>
    </div>

    <div id="view-wallet" class="view">
        <div class="balance-card">
            <p style="margin:0; opacity:0.8">Ganancias Acumuladas</p>
            <h1 id="walletBalance" style="margin:10px 0; font-size:36px">$0.00</h1>
            <button class="btn" style="background:white; color:var(--primary)" onclick="requestWithdrawal()">Retirar Fondos</button>
        </div>
        <h3>Historial de Smart Contracts</h3>
        <div id="txList">
            <p style="color:var(--secondary); text-align:center">No hay transacciones a煤n.</p>
        </div>
    </div>

    <div id="view-upload" class="view">
        <h2>Subir Contenido</h2>
        <div style="padding:50px; border:2px dashed var(--border); border-radius:15px; text-align:center">
             Selecciona evidencia para verificar
        </div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showView('home', this)"><br>Mapa</div>
    <div class="nav-item" onclick="showView('upload', this)"><br>Subir</div>
    <div class="nav-item" onclick="showView('wallet', this)"><br>Billetera</div>
</div>

<div id="modal">
    <div class="modal-content" id="modalBody"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ESTADO DE LA APP
    let userBalance = 0;
    let transactions = [];
    const feed = [
        { id: 1, title: "Robo en Joyer铆a", lat: -34.6037, lng: -58.3816, price: 50.00, trust: 98, status: 'sale' },
        { id: 2, title: "Inundaci贸n Local", lat: -34.6080, lng: -58.3720, price: 30.00, trust: 92, status: 'sale' },
        { id: 3, title: "Primicia Pol铆tica", lat: -34.5900, lng: -58.4000, price: 120.00, trust: 15, status: 'sale' }
    ];

    let map, markersLayer;

    // INICIAR APP
    window.onload = () => {
        initMap();
        renderGrid();
    };

    function initMap() {
        if(map) map.remove();
        const isDark = document.body.classList.contains('dark');
        map = L.map('map').setView([-34.6037, -58.3816], 13);
        const tiles = isDark 
            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        L.tileLayer(tiles).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
        renderMarkers();
    }

    function renderMarkers() {
        markersLayer.clearLayers();
        feed.forEach(item => {
            const isProtected = item.status === 'sale';
            // Ofuscaci贸n: si no est谩 paga, movemos el punto aleatoriamente
            const lat = isProtected ? item.lat + (Math.random()-0.5)*0.004 : item.lat;
            const lng = isProtected ? item.lng + (Math.random()-0.5)*0.004 : item.lng;
            
            const marker = L.circleMarker([lat, lng], {
                radius: 10, color: 'white', weight: 2, fillOpacity: 0.9,
                fillColor: item.trust > 80 ? '#4cd964' : '#ff3b30'
            }).addTo(markersLayer);

            marker.bindPopup(`<b>${item.title}</b><br><button onclick="openDetail(${item.id})">Ver Detalles</button>`);
        });
    }

    function renderGrid() {
        const grid = document.getElementById('newsFeed');
        grid.innerHTML = feed.map(item => `
            <div class="news-card" onclick="openDetail(${item.id})">
                <div class="price-badge">$${item.price}</div>
                <img src="https://picsum.photos/seed/${item.id}/200/100" class="${item.status === 'sale' ? 'blur' : ''}">
                <div class="card-body">
                    <div style="font-weight:bold; font-size:13px">${item.title}</div>
                    <div style="font-size:11px; color:var(--secondary)">Confianza: ${item.trust}%</div>
                </div>
            </div>
        `).join('');
    }

    // LGICA DE SMART CONTRACT
    function openDetail(id) {
        const item = feed.find(n => n.id === id);
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modalBody');
        
        modalBody.innerHTML = `
            <h3>${item.title}</h3>
            <p>Este contenido est谩 protegido por <b>Smart Contract Escrow</b>.</p>
            <ul>
                <li>Verificaci贸n GPS: OK</li>
                <li>Metadatos EXIF: ${item.trust}%</li>
            </ul>
            <p style="font-size:12px; color:var(--secondary)">Al comprar, se libera la ubicaci贸n exacta y el archivo original.</p>
            <button class="btn btn-buy" onclick="executeContract(${item.id})">Ejecutar Compra ($${item.price})</button>
            <button class="btn" onclick="closeModal()">Cancelar</button>
        `;
        modal.style.display = 'flex';
    }

    function executeContract(id) {
        const item = feed.find(n => n.id === id);
        if(item.status === 'sold') return;

        // Simulaci贸n de transacci贸n blockchain
        item.status = 'sold';
        const net = item.price * 0.95; // 5% comisi贸n plataforma
        userBalance += net;
        
        // Registrar en historial
        transactions.unshift({
            title: item.title,
            amount: net,
            date: new Date().toLocaleTimeString()
        });

        alert("CONTRATO EXITOSO:\n- Fondos transferidos al Escrow\n- Ubicaci贸n desbloqueada.");
        
        updateWalletUI();
        renderMarkers();
        renderGrid();
        closeModal();
    }

    function updateWalletUI() {
        document.getElementById('walletBalance').innerText = `$${userBalance.toFixed(2)}`;
        const list = document.getElementById('txList');
        if(transactions.length === 0) return;
        
        list.innerHTML = transactions.map(tx => `
            <div class="tx-item">
                <div>
                    <div style="font-weight:bold">${tx.title}</div>
                    <div style="font-size:11px; color:var(--secondary)">${tx.date} - Contrato Verificado</div>
                </div>
                <div style="color:var(--success); font-weight:bold">+$${tx.amount.toFixed(2)}</div>
            </div>
        `).join('');
    }

    // NAVEGACIN
    function showView(viewId, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(viewId === 'home') setTimeout(() => map.invalidateSize(), 100);
    }

    function locateUser() { map.locate({setView: true, maxZoom: 15}); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function requestWithdrawal() { alert("Solicitud de retiro enviada a tu cuenta vinculada."); }

    // THEME
    document.getElementById('themeToggle').onclick = () => {
        document.body.classList.toggle('dark');
        initMap();
    };
</script>

</body>
</html>
