<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Paywall News - Demo MP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0b0b0d; --bg-secondary: #07070a; --card: #111217;
  --text: #ffffff; --text-secondary: #9aa0a6; --muted: #6c757d;
  --accent: #ff3b30; --accent-hover: #ff5449; --border: rgba(255,255,255,0.06);
  --shadow: rgba(0,0,0,0.3); --overlay: rgba(0,0,0,0.7); --watermark: rgba(255,255,255,0.08);
  --success: #34c759; --warning: #ffcc00; --info: #0a84ff; --gold: #ffd700;
  --mp-blue: #009EE3; /* Color MercadoPago */
}
body.light {
  --bg: #f8f9fa; --bg-secondary: #ffffff; --card: #ffffff;
  --text: #1a1a1a; --text-secondary: #6c757d; --border: rgba(0,0,0,0.08);
  --watermark: rgba(0,0,0,0.1);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; transition: background 0.3s; }

header { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
.brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }
.header-actions { display: flex; gap: 15px; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 110px; }

/* MAPA */
.map-container { height: 360px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 24px; position: relative; border: 1px solid var(--border); z-index: 1; }
#map { height: 100%; width: 100%; }
.gps-btn { position: absolute; bottom: 20px; right: 20px; z-index: 1000; background: var(--card); color: var(--text); border: none; padding: 12px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; font-size: 20px; transition: transform 0.2s; }
.gps-btn:hover { transform: scale(1.1); }
.map-legend { position: absolute; left: 16px; bottom: 16px; background: var(--overlay); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 12px; font-size: 12px; z-index: 1000; color: white; display: flex; gap: 15px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

/* LOGIN SCREEN */
#login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.role-card { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 20px; width: 100%; max-width: 320px; text-align: center; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
.role-card:hover { transform: translateY(-5px); border-color: var(--accent); }
.role-icon { font-size: 50px; margin-bottom: 15px; }

/* GRID NOTICIAS */
.news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
.news-card { background: var(--card); border-radius: 16px; overflow: hidden; position: relative; cursor: pointer; transition: 0.3s; border: 1px solid var(--border); }
.news-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px var(--shadow); }
.news-card.is-mine { border: 2px solid var(--info); box-shadow: 0 0 15px rgba(10, 132, 255, 0.15); }

.news-card-image { width: 100%; aspect-ratio: 16/10; position: relative; overflow: hidden; }
.news-card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
.news-card:hover img { transform: scale(1.05); }

.watermark-overlay { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); pointer-events: none; z-index: 5; overflow: hidden; }
.watermark-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-25deg); color: var(--watermark); text-align: center; }
.wm-brand { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
.wm-user { font-size: 7px; font-weight: 400; margin-top: 2px; }

.price-badge { position: absolute; top: 12px; right: 12px; background: var(--overlay); color: white; padding: 6px 10px; border-radius: 8px; font-weight: 700; font-size: 13px; z-index: 10; backdrop-filter: blur(5px); }
.license-badge { position: absolute; top: 12px; left: 12px; padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; z-index: 10; text-transform: uppercase; backdrop-filter: blur(5px); }
.lic-exclusive { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.lic-nonexclusive { background: rgba(0, 122, 255, 0.9); color: white; }
.trust-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; background: rgba(52, 199, 89, 0.15); color: var(--success); border: 1px solid var(--success); margin-top: 5px; }

.stats-container { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border); }
.chart-wrapper { height: 180px; width: 100%; margin-top: 15px; }
.tab-btn { padding: 5px 12px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
.tab-btn.active { background: var(--bg); color: var(--accent); }
.list-card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
.list-item { display: flex; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); align-items: center; transition: 0.2s; }
.list-item:hover { background: var(--bg); }
.list-item-image { width: 70px; height: 50px; border-radius: 8px; object-fit: cover; }
.list-item-content { flex: 1; }

.offer-section { background: var(--bg); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-top: 20px; }
.quick-offers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
.quick-offer-btn { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
.quick-offer-btn:hover { border-color: var(--gold); transform: translateY(-2px); }
.timer-box { background: rgba(255, 59, 48, 0.1); padding: 12px; border-radius: 10px; text-align: center; margin: 15px 0; border: 1px solid var(--accent); }
.timer-countdown { font-family: monospace; font-size: 26px; font-weight: 700; color: var(--accent); }

.form-input { width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 10px; }
.license-option { padding: 16px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; margin-bottom: 10px; transition: 0.2s; position: relative; }
.license-option.selected { border-color: var(--accent); background: rgba(255, 59, 48, 0.05); }
.info-btn { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--text-secondary); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }
.legal-text { display: none; margin-top: 10px; font-size: 12px; color: var(--text-secondary); padding-top: 10px; border-top: 1px solid var(--border); line-height: 1.4; }

.btn { padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; width: 100%; transition: 0.2s; }
.btn-primary { background: var(--accent); color: white; }
.btn-gold { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.btn-secondary { background: var(--border); color: var(--text); }
.btn-danger { background: rgba(255, 59, 48, 0.1); color: #ff3b30; border: 1px solid #ff3b30; }
.icon-btn { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: transparent; border: none; font-size: 20px; }

/* MERCADOPAGO STYLES */
.btn-mp { background: var(--mp-blue); color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-mp:hover { filter: brightness(1.1); }
.mp-logo-text { font-style: italic; font-weight: 900; letter-spacing: -0.5px; }

/* LOADING OVERLAY */
.mp-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #333; }
.mp-overlay.dark-mode { background: rgba(0,0,0,0.9); color: white; }
.spinner { width: 50px; height: 50px; border: 5px solid rgba(0, 158, 227, 0.2); border-top-color: var(--mp-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
@keyframes spin { to { transform: rotate(360deg); } }

.modal { position: fixed; inset: 0; background: var(--overlay); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
.modal.active { display: flex; }
.modal-content { background: var(--card); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

.bottom-nav { position: fixed; left: 16px; right: 16px; bottom: 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; display: flex; padding: 10px; z-index: 100; box-shadow: 0 8px 32px var(--shadow); }
.nav-item { flex: 1; text-align: center; padding: 5px; cursor: pointer; font-size: 11px; color: var(--text-secondary); position: relative; }
.nav-item.active { color: var(--accent); font-weight: 700; }
.nav-item-icon { font-size: 20px; margin-bottom: 4px; }
.notif-badge { position: absolute; top: 2px; right: 30%; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; display: none; border: 2px solid var(--card); }
.notif-badge.active { display: block; animation: pulse 2s infinite; }
.view { display: none; } .view.active { display: block; }
</style>
</head>
<body class="dark">

<div id="mpOverlay" class="mp-overlay dark-mode">
    <div class="spinner"></div>
    <h3>Procesando pago seguro...</h3>
    <small style="color:var(--mp-blue); margin-top:5px">Mercado Pago</small>
</div>

<div id="login-screen">
    <div style="font-size:40px; margin-bottom:10px">üì∞</div>
    <h1 style="margin-bottom:30px">Paywall News</h1>
    <div class="role-card" onclick="loginAs('witness')">
        <div class="role-icon">üì±</div>
        <h3>Tengo una noticia</h3>
        <p style="color:var(--text-secondary); font-size:13px">Estoy en el lugar de los hechos.<br>Quiero vender mi contenido.</p>
    </div>
    <div class="role-card" onclick="loginAs('media')">
        <div class="role-icon">üì∫</div>
        <h3>Soy Medio</h3>
        <p style="color:var(--text-secondary); font-size:13px">Busco noticias exclusivas.<br>Quiero comprar los derechos.</p>
    </div>
</div>

<header>
  <div class="brand"><span style="font-size: 24px;">üì∞</span><span>Paywall News</span></div>
  <div class="header-actions">
    <button class="icon-btn" id="themeToggle" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">üåô</button>
    <button class="icon-btn" onclick="showView('profile')" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">üë§</button>
  </div>
</header>

<div class="container">
  
  <div id="view-home" class="view active">
    <div class="map-container">
      <div id="map"></div>
      <button class="gps-btn" onclick="locateUser()">üéØ</button>
      <div class="map-legend">
        <div><span class="legend-dot" style="background: #ff3b30;"></span> Alta</div>
        <div><span class="legend-dot" style="background: #ffcc00;"></span> Media</div>
        <div><span class="legend-dot" style="background: #4cd964;"></span> Baja</div>
      </div>
    </div>
    <div class="section-header"><div class="section-title">√öltimas noticias</div></div>
    <div class="news-grid" id="homeGrid"></div>
  </div>

  <div id="view-discover" class="view">
    <div class="section-header"><div class="section-title">Explorar</div></div>
    <div style="display:flex; gap:10px; margin-bottom:20px">
        <input type="text" class="form-input" id="searchInput" placeholder="Buscar hashtags, t√≠tulos..." style="margin-bottom:0">
        <button class="icon-btn" style="background:var(--card); border:1px solid var(--border); border-radius:12px; width:50px">‚öôÔ∏è</button>
    </div>
    <div id="trendingTags" style="margin-bottom:20px; overflow-x:auto; white-space:nowrap; padding-bottom:5px"></div>
    <div class="news-grid" id="discoverGrid"></div>
  </div>

  <div id="view-upload" class="view">
    <div class="section-header"><div class="section-title">Subir contenido</div></div>
    <div class="list-card">
      <form id="uploadForm">
        <div class="form-group"><label class="form-label">Archivo</label><input type="file" id="upFile" class="form-input" required></div>
        <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" id="upTitle" class="form-input" required></div>
        <div class="form-group"><label class="form-label">Hashtags (Sugeridos: <span id="sugTags" style="color:var(--accent)"></span>)</label><input type="text" id="upTags" class="form-input"></div>
        <div class="form-group">
            <label class="form-label">Licencia</label>
            <div class="license-options">
                <div class="license-option selected" id="opt-nonexclusive" onclick="selectLic(this, 'nonexclusive')">
                    <strong>üåê No Exclusiva</strong><br><small>Venta m√∫ltiple permitida.</small>
                    <div class="info-btn" onclick="toggleLegal(event, 'legal-non')">?</div>
                    <div id="legal-non" class="legal-text">Permite a m√∫ltiples medios utilizar el contenido. El autor retiene la propiedad.</div>
                </div>
                <div class="license-option" id="opt-exclusive" onclick="selectLic(this, 'exclusive')">
                    <strong>üèÜ Exclusiva</strong><br><small>Un solo comprador. Mayor precio.</small>
                    <div class="info-btn" onclick="toggleLegal(event, 'legal-ex')">?</div>
                    <div id="legal-ex" class="legal-text">Transfiere los derechos exclusivos. Se retira del mercado tras la venta.</div>
                </div>
                <input type="hidden" id="licInput" value="nonexclusive">
            </div>
        </div>
        <div class="form-group"><label class="form-label">Precio (USD)</label><input type="number" id="upPrice" class="form-input" placeholder="50"></div>
        <button type="submit" id="btnUpload" class="btn btn-primary">üì§ Analizar Metadatos y Publicar</button>
      </form>
    </div>
  </div>

  <div id="view-sales" class="view">
    <div class="section-header"><div class="section-title">Mis Noticias</div></div>
    <div id="pendingOffersCard" style="display:none; margin-bottom:20px; border:2px solid var(--warning); border-radius:16px; padding:15px; background:rgba(255,204,0,0.05)">
        <h3 style="color:var(--warning); margin-bottom:10px; font-size:16px">üîî Ofertas Recibidas</h3>
        <div id="offersList"></div>
    </div>
    <div class="stats-container">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <strong>Rendimiento</strong>
            <div class="stats-tabs">
                <button class="tab-btn active" onclick="updateChart('week', this)">Sem</button>
                <button class="tab-btn" onclick="updateChart('month', this)">Mes</button>
                <button class="tab-btn" onclick="updateChart('year', this)">A√±o</button>
            </div>
        </div>
        <div class="chart-wrapper"><canvas id="earningsChart"></canvas></div>
    </div>
    <div class="list-card"><h3 style="margin-bottom:16px">Mis Ventas</h3><div id="salesList"></div></div>
    <div class="list-card"><h3 style="margin-bottom:16px">Mis Compras</h3><div id="purchasesList"></div></div>
  </div>

  <div id="view-wallet" class="view">
    <div class="section-header"><div class="section-title">Billetera</div></div>
    <div class="list-card" style="text-align:center; padding:40px 20px">
        <div style="font-size:48px; margin-bottom:10px">üí∞</div>
        <div style="color:var(--text-secondary)">Saldo disponible</div>
        <div id="walletBalance" style="font-size:42px; font-weight:800; margin:10px 0"></div>
        <div id="mpConnectState">
             </div>
    </div>
    <div class="list-card">
        <h3>Historial</h3>
        <div class="list-item"><div class="list-item-content"><div>Registro</div><small>Cuenta nueva</small></div><strong>$0</strong></div>
    </div>
  </div>

  <div id="view-profile" class="view">
    <div class="section-header"><div class="section-title">Mi Perfil</div></div>
    <div class="list-card" style="text-align:center">
        <div style="font-size:60px" id="userAvatar">üë§</div>
        <h2 id="userNameDisplay">Usuario</h2>
        <p id="userRoleDisplay" style="color:var(--success)">Rol</p>
    </div>
    <div class="list-card" onclick="logout()" style="cursor:pointer; text-align:center; color:var(--accent)">üîÑ <strong>Cambiar de Usuario</strong></div>
    <div class="list-card" onclick="showView('accounts')" style="cursor:pointer">
        <div class="list-item" style="border:none; padding:0">
            <div style="font-size:24px; margin-right:15px">üë•</div>
            <div class="list-item-content"><div class="list-item-title">Subcuentas</div><div class="list-item-meta">Gestionar equipo y dispositivos</div></div>
            <div>‚Ä∫</div>
        </div>
    </div>
    <div class="list-card"><button class="btn btn-secondary" onclick="resetData()">üîÅ Resetear Base de Datos</button></div>
  </div>

  <div id="view-accounts" class="view">
    <div class="section-header"><div class="section-title">Subcuentas</div></div>
    <div class="list-card" id="subaccountsList"></div>
    <button class="btn btn-primary" onclick="alert('Nueva subcuenta')">‚ûï Agregar</button>
  </div>
</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="showView('home')"><div class="nav-item-icon">üè†</div>Inicio</div>
  <div class="nav-item" onclick="showView('discover')"><div class="nav-item-icon">üîç</div>Explorar</div>
  <div class="nav-item" onclick="showView('upload')"><div class="nav-item-icon">üì§</div>Subir</div>
  <div class="nav-item" onclick="showView('sales')"><div id="navNotif" class="notif-badge"></div><div class="nav-item-icon">üìä</div>Ventas</div>
  <div class="nav-item" onclick="showView('wallet')"><div class="nav-item-icon">üí∞</div>Wallet</div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between">
      <h3 id="modalTitle">Detalle</h3>
      <button onclick="closeModal()" style="background:none; border:none; color:var(--text); font-size:24px; cursor:pointer">‚úï</button>
    </div>
    <div id="modalBody" style="padding:20px"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ============ DATOS INICIALES ============
const usersDB = {
    'witness': { id: 'witness', name: 'Mat√≠as (Vendedor)', role: 'Fuente Directa', balance: 150, avatar: 'üì±', mpLinked: false },
    'media': { id: 'media', name: 'InfoGlobal (Medio)', role: 'Prensa', balance: 5000, avatar: 'üì∫', mpLinked: true }
};

const defaultFeed = [
  {id:1, ownerId:'witness', title:'Choque en Av. Mitre', price:50, lat:-34.6037, lng:-58.3816, img:'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#accidente #transito', importance:'high', trustScore: 98, buyers:[]},
  {id:2, ownerId:'witness', title:'Incendio en F√°brica', price:150, lat:-34.6070, lng:-58.3772, img:'https://images.unsplash.com/photo-1577962917302-cd874c4e31d2?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#urgente #quilmes', importance:'medium', trustScore: 85, buyers:[]},
  {id:3, ownerId:'other', title:'Protesta en el Obelisco', price:80, lat:-34.6030, lng:-58.3810, img:'https://images.unsplash.com/photo-1590856029826-c7a73142bbf1?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#protesta #centro', importance:'medium', trustScore: 90, buyers:[]},
  {id:4, ownerId:'other', title:'Inundaci√≥n en Palermo', price:200, lat:-34.5800, lng:-58.4200, img:'https://images.unsplash.com/photo-1548685913-fe6678babe8d?w=800', licenseType:'exclusive', status:'for_sale', hashtags: '#clima #alerta', importance:'high', trustScore: 95, buyers:[]},
  {id:5, ownerId:'other', title:'Derrumbe en Obra', price:120, lat:-34.6100, lng:-58.4000, img:'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#policiales', importance:'medium', trustScore: 88, buyers:[]}
];
let subaccounts = [{name: 'C√°mara Frontal', files: 12, img: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100'}, {name: 'Dron A√©reo', files: 7, img: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100'}];

let feed = JSON.parse(localStorage.getItem('pw_feed')) || defaultFeed;
let users = JSON.parse(localStorage.getItem('pw_users')) || usersDB;
let negotiations = JSON.parse(localStorage.getItem('pw_negs')) || [];
let activeUser = null; 

// LOGIN/LOGOUT
function loginAs(userId) { activeUser = users[userId]; localStorage.setItem('pw_active_id', userId); document.getElementById('login-screen').style.display = 'none'; initApp(); }
function logout() { localStorage.removeItem('pw_active_id'); location.reload(); }
function initApp() { updateProfileUI(); updateWalletUI(); showView('home'); renderGrid('homeGrid', feed); }
const storedId = localStorage.getItem('pw_active_id'); if (storedId && users[storedId]) { activeUser = users[storedId]; document.getElementById('login-screen').style.display = 'none'; initApp(); }

function saveData() { localStorage.setItem('pw_feed', JSON.stringify(feed)); localStorage.setItem('pw_users', JSON.stringify(users)); localStorage.setItem('pw_negs', JSON.stringify(negotiations)); updateWalletUI(); }
function resetData() { localStorage.clear(); location.reload(); }

function updateProfileUI() { document.getElementById('userNameDisplay').textContent = activeUser.name; document.getElementById('userRoleDisplay').textContent = activeUser.role; document.getElementById('userAvatar').textContent = activeUser.avatar; }
function updateWalletUI() { 
    document.getElementById('walletBalance').textContent = `$${activeUser.balance}`;
    const mpContainer = document.getElementById('mpConnectState');
    if(activeUser.mpLinked) {
        mpContainer.innerHTML = `<button class="btn btn-mp" onclick="withdrawMP()">Retirar a <span class="mp-logo-text">Mercado Pago</span></button><div style="text-align:center; margin-top:10px; font-size:12px; color:var(--success)">‚úÖ Cuenta Vinculada</div>`;
    } else {
        mpContainer.innerHTML = `<button class="btn btn-secondary" onclick="linkMP()">üîó Vincular Mercado Pago</button>`;
    }
}

// SIMULACION MP
function linkMP() {
    const alias = prompt("Ingresa tu Alias o CVU de MercadoPago:");
    if(alias) {
        activeUser.mpLinked = true;
        saveData();
        alert("‚úÖ Cuenta vinculada exitosamente.");
    }
}
function withdrawMP() {
    if(activeUser.balance <= 0) return alert("Sin fondos disponibles.");
    document.getElementById('mpOverlay').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('mpOverlay').style.display = 'none';
        activeUser.balance = 0;
        saveData();
        alert("üí∏ Fondos enviados a tu cuenta MercadoPago.");
    }, 2000);
}
function showProcessing() { return new Promise(r => { document.getElementById('mpOverlay').style.display = 'flex'; setTimeout(() => { document.getElementById('mpOverlay').style.display = 'none'; r(); }, 2000); }); }

// MAPA
let map = null; let markersLayer = L.layerGroup(); let userMarker = null;
function initMap() { if (map) return; map = L.map('map', {zoomControl: false}).setView([-34.6037, -58.3816], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); markersLayer.addTo(map); renderMapMarkers(); }
function getObfuscatedCoords(lat, lng) { return [lat + (Math.random() - 0.5) * 0.003, lng + (Math.random() - 0.5) * 0.003]; }
function renderMapMarkers() {
    markersLayer.clearLayers();
    feed.forEach(item => {
        const isOwner = item.ownerId === activeUser.id; const iBoughtIt = item.buyers.includes(activeUser.id);
        const canSeeExact = isOwner || iBoughtIt || (item.status === 'sold' && iBoughtIt);
        const displayCoords = canSeeExact ? [item.lat, item.lng] : getObfuscatedCoords(item.lat, item.lng);
        const color = item.importance === 'high' ? '#ff3b30' : (item.importance === 'medium' ? '#ffcc00' : '#4cd964');
        const marker = L.marker(displayCoords, {icon: L.divIcon({ className: '', html: `<div style="width:24px;height:24px;background:${color};border-radius:50% 50% 50% 0;transform:rotate(45deg);border:2px solid white;box-shadow:0 3px 8px rgba(0,0,0,0.3);"></div>`, iconSize: [24,24] })}).addTo(markersLayer);
        marker.on('click', () => openDetail(item.id));
        if (!canSeeExact) L.circle(displayCoords, {color: color, fillColor: color, fillOpacity: 0.1, radius: 400, weight: 1, dashArray: '5, 5'}).addTo(markersLayer);
    });
}
function locateUser() { navigator.geolocation.getCurrentPosition(pos => { const {latitude, longitude} = pos.coords; map.setView([latitude, longitude], 14); if(userMarker) map.removeLayer(userMarker); userMarker = L.marker([latitude, longitude], {icon: L.divIcon({html: '<div style="background:#007aff;width:15px;height:15px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 10px rgba(0,122,255,0.2)"></div>'})}).addTo(map); }); }

// UI RENDER
function generateWatermark() { let c=''; for(let i=0;i<9;i++) c+=`<div class="watermark-cell"><span class="wm-brand">Paywall News</span><span class="wm-user">Propiedad Protegida</span></div>`; return `<div class="watermark-overlay">${c}</div>`; }
function getTrustBadge(score) { return score > 90 ? `<div class="trust-badge">üõ°Ô∏è GPS VERIFICADO</div>` : ''; }

function renderGrid(id, items) {
  const container = document.getElementById(id); if(!container) return;
  if(items.length===0) { container.innerHTML='<div style="padding:20px;color:var(--text-secondary)">Nada por aqu√≠.</div>'; return; }
  container.innerHTML = items.map(item => {
    let statusLabel='‚óè Disponible', statusColor='var(--success)', mineClass = item.ownerId===activeUser.id ? 'is-mine' : '';
    if(item.status==='negotiating') { statusLabel='‚óè Negociando'; statusColor='var(--warning)'; }
    if(item.status==='sold' && item.licenseType==='exclusive') { statusLabel='‚óè Vendido'; statusColor='var(--muted)'; }
    if(item.buyers.includes(activeUser.id)) { statusLabel='‚úÖ Adquirida'; statusColor='var(--info)'; }
    const showWm = (item.ownerId !== activeUser.id) && !item.buyers.includes(activeUser.id);
    return `<div class="news-card ${mineClass}" onclick="openDetail(${item.id})">
      <div class="news-card-image"><img src="${item.img}">${showWm?generateWatermark():''}<div class="price-badge">$${item.price}</div><div class="license-badge ${item.licenseType==='exclusive'?'lic-exclusive':'lic-nonexclusive'}">${item.licenseType==='exclusive'?'üèÜ':'üåê'}</div></div>
      <div style="padding:15px"><div class="list-item-title">${item.title}</div>${getTrustBadge(item.trustScore||0)}<div style="font-size:12px;color:var(--info);margin:5px 0">${item.hashtags}</div><small style="color:${statusColor}">${statusLabel}</small></div>
    </div>`;
  }).join('');
}

// DETALLES Y NEGOCIACION
let activeInterval = null;

function openDetail(id) {
  const item = feed.find(x => x.id === id);
  const myNeg = negotiations.find(n => n.newsId === id && n.buyerId === activeUser.id && n.status !== 'rejected');
  
  document.getElementById('modalTitle').textContent = item.title;
  const isOwner = item.ownerId === activeUser.id;
  const iBoughtIt = item.buyers.includes(activeUser.id);
  const showWm = !isOwner && !iBoughtIt;

  let ui = `<div style="position:relative;border-radius:12px;overflow:hidden;margin-bottom:15px"><img src="${item.img}" style="width:100%">${showWm?generateWatermark():''}</div>${getTrustBadge(item.trustScore||0)}<p style="margin:10px 0;color:var(--text-secondary)">${item.hashtags}</p>`;

  if (isOwner) {
      ui += `<div class="list-card" style="text-align:center;background:rgba(10,132,255,0.1);border-color:var(--info)"><h3>üìù Tu Noticia</h3><p>Gestiona ofertas en la pesta√±a "Ventas".</p></div>`;
  } else if (iBoughtIt) {
      ui += `<div class="list-card" style="text-align:center;background:rgba(52,199,89,0.1);border-color:var(--success)"><h3 style="color:var(--success)">‚úÖ Contenido Desbloqueado</h3></div>`;
  } else {
      if (myNeg) {
          if (myNeg.status === 'pending') {
             ui += `<div class="list-card" style="text-align:center;border-color:var(--warning)"><h3 style="color:var(--warning)">‚è≥ Oferta Enviada: $${myNeg.amount}</h3><p>Esperando respuesta del vendedor...</p></div>`;
          } else if (myNeg.status === 'counter_pending') {
             ui += `<div class="list-card" style="text-align:center;border-color:var(--gold);background:rgba(255,215,0,0.05)">
                <h3 style="color:var(--gold)">üîÑ Contraoferta: $${myNeg.amount}</h3>
                <p>El vendedor pide este monto.</p>
                <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
                    <button class="btn btn-primary" onclick="acceptCounter(${myNeg.id})">ACEPTAR $${myNeg.amount}</button>
                    <button class="btn btn-danger" onclick="rejectCounter(${myNeg.id})">RECHAZAR</button>
                </div>
             </div>`;
          }
      } else {
          if(item.status === 'negotiating' && !myNeg) {
              ui += `<div class="list-card" style="text-align:center"><p>‚ö†Ô∏è Esta noticia est√° siendo negociada por otro medio.</p></div>`;
          } else if(item.licenseType === 'exclusive') {
            ui += `<button class="btn btn-mp" style="width:100%" onclick="buyDirect(${item.id})"><span class="mp-logo-text">Mercado Pago</span> - Comprar Exclusivo $${item.price}</button>`;
          } else {
            ui += `<button class="btn btn-mp" style="width:100%; margin-bottom:15px" onclick="buyDirect(${item.id})"><span class="mp-logo-text">Mercado Pago</span> - Comprar $${item.price}</button>
                   <div class="offer-section"><h4 style="text-align:center;color:var(--gold);margin-bottom:10px">üíé Negociar</h4>
                   <div class="quick-offers">
                       <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*2})"><strong>X2</strong><br>$${item.price*2}</div>
                       <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*3})"><strong>X3</strong><br>$${item.price*3}</div>
                       <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*4})"><strong>X4</strong><br>$${item.price*4}</div>
                   </div>
                   <div style="display:flex;gap:10px"><input type="number" id="cOffer" placeholder="Monto..." class="form-input" style="margin:0"><button class="btn btn-gold" style="width:auto" onclick="sendManualOffer(${item.id})">Enviar</button></div></div>`;
          }
      }
  }
  document.getElementById('modalBody').innerHTML = ui;
  document.getElementById('modal').classList.add('active');
}

async function buyDirect(id) {
    const item = feed.find(x => x.id === id);
    if(activeUser.balance < item.price) return alert("Saldo insuficiente");
    
    await showProcessing(); // SIMULACION PAGO
    
    activeUser.balance -= item.price;
    users[item.ownerId].balance += item.price;
    item.buyers.push(activeUser.id);
    if(item.licenseType === 'exclusive') item.status = 'sold';
    saveData(); renderMapMarkers(); closeModal(); renderAllViews(); 
    alert("‚úÖ Pago aprobado por Mercado Pago.");
}

function makeOffer(itemId, amount) {
    const existing = negotiations.find(n => n.newsId === itemId && n.buyerId === activeUser.id && n.status !== 'rejected');
    if(existing) return alert("Ya tienes una negociaci√≥n activa.");
    const expiresAt = Date.now() + (15 * 60 * 1000);
    negotiations.push({ id: Date.now(), newsId: itemId, buyerId: activeUser.id, amount, status: 'pending', expiresAt });
    feed.find(x => x.id === itemId).status = 'negotiating';
    saveData(); closeModal(); renderAllViews(); alert("Oferta enviada.");
}
function sendManualOffer(id) { const val = Number(document.getElementById('cOffer').value); if(val>0) makeOffer(id, val); }

function showSellerPanel(negId) {
    const neg = negotiations.find(n => n.id === negId);
    const item = feed.find(f => f.id === neg.newsId);
    document.getElementById('modalTitle').textContent = 'Gestionar Oferta';
    document.getElementById('modalBody').innerHTML = `
        <div class="timer-box"><small>EXPIRA EN</small><div id="countdown" class="timer-countdown">15:00</div></div>
        <div style="text-align:center;padding:20px;background:var(--bg);border-radius:15px;margin-bottom:15px">
            <h1 style="color:var(--gold);font-size:42px">$${neg.amount}</h1><p>${item.title}</p>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px">
            <button class="btn btn-primary" onclick="acceptOffer(${negId})">ACEPTAR</button>
            <button class="btn btn-danger" onclick="rejectOffer(${negId})">RECHAZAR</button>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:15px">
            <label style="font-size:12px;color:var(--text-secondary)">Contraoferta:</label>
            <div style="display:flex;gap:10px;margin-top:5px"><input type="number" id="counterAmt" class="form-input" style="margin:0" placeholder="$"><button class="btn btn-secondary" style="width:auto" onclick="sendCounter(${negId})">Enviar</button></div>
        </div>`;
    document.getElementById('modal').classList.add('active');
    startTimer(neg.expiresAt);
}

function startTimer(expiresAt) {
    if(activeInterval) clearInterval(activeInterval);
    const update = () => {
        const el = document.getElementById('countdown');
        if(!el) return;
        const diff = expiresAt - Date.now();
        if(diff <= 0) { el.textContent = "00:00"; clearInterval(activeInterval); return; }
        const mins = Math.floor(diff/60000);
        const secs = Math.floor((diff%60000)/1000);
        el.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    };
    update();
    activeInterval = setInterval(update, 1000);
}

function sendCounter(negId) {
    const val = Number(document.getElementById('counterAmt').value);
    if(!val) return;
    const neg = negotiations.find(n => n.id === negId);
    neg.amount = val;
    neg.status = 'counter_pending'; 
    neg.expiresAt = Date.now() + (15 * 60 * 1000); 
    saveData(); closeModal(); renderAllViews(); alert("Contraoferta enviada al comprador.");
}

async function acceptOffer(id) {
    const neg = negotiations.find(n => n.id === id);
    const item = feed.find(f => f.id === neg.newsId);
    
    await showProcessing(); // SIMULACION
    
    item.price = neg.amount; 
    item.status = 'sold'; neg.status = 'accepted'; item.buyers.push(neg.buyerId);
    users[neg.buyerId].balance -= neg.amount; activeUser.balance += neg.amount;
    saveData(); closeModal(); renderAllViews(); alert("Venta realizada.");
}
function rejectOffer(id) {
    const neg = negotiations.find(n => n.id === id);
    neg.status = 'rejected'; feed.find(x => x.id === neg.newsId).status = 'for_sale';
    saveData(); closeModal(); renderAllViews(); alert("Oferta rechazada.");
}

async function acceptCounter(negId) {
    const neg = negotiations.find(n => n.id === negId);
    if(activeUser.balance < neg.amount) return alert("Saldo insuficiente");
    const item = feed.find(f => f.id === neg.newsId);
    
    await showProcessing(); // SIMULACION
    
    item.price = neg.amount;
    item.status = 'sold'; neg.status = 'accepted'; item.buyers.push(activeUser.id);
    activeUser.balance -= neg.amount; users[item.ownerId].balance += neg.amount;
    saveData(); closeModal(); renderAllViews(); alert("Contraoferta aceptada.");
}
function rejectCounter(negId) { rejectOffer(negId); }

// SUBIR
document.getElementById('uploadForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if(activeUser.id !== 'witness') return alert("Solo el vendedor puede subir.");
    const btn = document.getElementById('btnUpload'); btn.textContent = "üõ∞Ô∏è Verificando..."; btn.disabled = true;
    setTimeout(() => {
        const title = document.getElementById('upTitle').value; const price = Number(document.getElementById('upPrice').value); const tags = document.getElementById('upTags').value; const lic = document.getElementById('licInput').value;
        const newItem = { id: Date.now(), ownerId: activeUser.id, title: title, price: price, lat: -34.6037+(Math.random()-0.5)*0.05, lng: -58.3816+(Math.random()-0.5)*0.05, img: 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800', licenseType: lic, status: 'for_sale', hashtags: tags, importance: 'high', trustScore: 95, buyers: [] };
        feed.unshift(newItem); saveData(); renderMapMarkers(); renderAllViews(); e.target.reset(); closeModal(); showView('home'); btn.textContent = "üì§ Publicar"; btn.disabled = false; alert("‚úÖ Noticia subida.");
    }, 1000);
});
function toggleLegal(e, id) { e.stopPropagation(); const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }

// VISTAS
function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById(`view-${name}`).style.display = 'block';
    if(name === 'home') setTimeout(() => { if(!map) initMap(); else { map.invalidateSize(); renderMapMarkers(); } }, 100);
    if(name === 'sales') { renderSales(); initChart(); } 
    if(name === 'discover') renderGrid('discoverGrid', feed);
    if(name === 'upload') document.getElementById('sugTags').textContent = ["#accidente", "#politica"].join(", ");
    if(name === 'accounts') renderSubs();
    const mapNav = {'home':0, 'discover':1, 'upload':2, 'sales':3, 'wallet':4};
    if(mapNav[name] !== undefined) document.querySelectorAll('.nav-item')[mapNav[name]].classList.add('active');
}

function renderSales() {
    const pending = negotiations.filter(n => n.status === 'pending' || n.status === 'counter_pending');
    const showNotif = (activeUser.id === 'witness' && pending.some(n => n.status === 'pending')) || (activeUser.id === 'media' && pending.some(n => n.status === 'counter_pending'));
    document.getElementById('pendingOffersCard').style.display = showNotif ? 'block' : 'none';
    document.getElementById('navNotif').classList.toggle('active', showNotif);
    
    document.getElementById('offersList').innerHTML = pending.map(n => {
        if (activeUser.id === 'witness' && n.status === 'pending') 
            return `<div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg);padding:10px;border-radius:10px;margin-bottom:8px"><div><strong>$${n.amount}</strong><br><small>Oferta Nueva</small></div><button class="btn btn-primary" style="width:auto;padding:8px 15px" onclick="showSellerPanel(${n.id})">Gestionar</button></div>`;
        if (activeUser.id === 'media' && n.status === 'counter_pending')
             return `<div style="display:flex;justify-content:space-between;align-items:center;background:var(--bg);padding:10px;border-radius:10px;margin-bottom:8px"><div><strong>$${n.amount}</strong><br><small>Contraoferta recibida</small></div><button class="btn btn-mp" style="width:auto;padding:8px 15px" onclick="openDetail(${n.newsId})">Ver</button></div>`;
        return '';
    }).join('');
    
    if(activeUser.id === 'witness') {
        const mySold = feed.filter(f => f.ownerId === activeUser.id && (f.status === 'sold' || f.buyers.length > 0));
        document.getElementById('salesList').innerHTML = mySold.map(s => `<div class="list-item"><img src="${s.img}" class="list-item-image"><div class="list-item-content"><div class="list-item-title">${s.title}</div><small>Vendido</small></div><strong style="color:var(--success)">+$${s.price}</strong></div>`).join('');
        document.getElementById('purchasesList').innerHTML = '<div style="padding:10px; color:var(--muted)">No compras noticias.</div>';
    } else {
        const myPurchases = feed.filter(f => f.buyers.includes(activeUser.id));
        document.getElementById('purchasesList').innerHTML = myPurchases.map(p => `<div class="list-item"><img src="${p.img}" class="list-item-image"><div class="list-item-content"><div class="list-item-title">${p.title}</div><small>Adquirido</small></div><strong style="color:var(--accent)">-$${p.price}</strong></div>`).join('');
        document.getElementById('salesList').innerHTML = '<div style="padding:10px; color:var(--muted)">No vendes noticias.</div>';
    }
}

function renderSubs() { document.getElementById('subaccountsList').innerHTML = subaccounts.map(s => `<div class="list-item"><img src="${s.img}" class="list-item-image" style="border-radius:50%; width:50px; height:50px"><div class="list-item-content"><div>${s.name}</div><small>${s.files} archivos</small></div></div>`).join(''); }
function selectLic(el, type) { document.querySelectorAll('.license-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); document.getElementById('licInput').value = type; }
function closeModal() { document.getElementById('modal').classList.remove('active'); clearInterval(activeInterval); }

let earningsChart = null;
function initChart() {
    if(earningsChart) { earningsChart.destroy(); earningsChart = null; }
    const ctx = document.getElementById('earningsChart').getContext('2d');
    earningsChart = new Chart(ctx, { type: 'bar', data: { labels: ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'], datasets: [{ data: [50,90,45,130,110,200,75], backgroundColor: '#ff3b30', borderRadius:4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y:{display:false}, x:{grid:{display:false}} } } });
}
function updateChart(p, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
    if(p==='month') { earningsChart.data.labels = ['Sem 1','Sem 2','Sem 3','Sem 4']; earningsChart.data.datasets[0].data = [450, 800, 600, 1000]; }
    else if(p==='year') { earningsChart.data.labels = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']; earningsChart.data.datasets[0].data = [1200,1500,1100,1700,1900,2400,2000,2100,2300,2700,2500,3400]; }
    else { earningsChart.data.labels = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom']; earningsChart.data.datasets[0].data = [50,90,45,130,110,200,75]; }
    earningsChart.update();
}

document.getElementById('themeToggle').onclick = () => document.body.classList.toggle('light');
document.getElementById('searchInput').oninput = (e) => { const v = e.target.value.toLowerCase(); renderGrid('discoverGrid', feed.filter(i => i.title.toLowerCase().includes(v) || i.hashtags.toLowerCase().includes(v))); };
</script>
</body>
</html>