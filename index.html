<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Paywall News - Marketplace Profesional</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0b0b0d; --bg-secondary: #07070a; --card: #111217;
  --text: #ffffff; --text-secondary: #9aa0a6; --muted: #6c757d;
  --accent: #ff3b30; --accent-hover: #ff5449; --border: rgba(255,255,255,0.06);
  --shadow: rgba(0,0,0,0.3); --overlay: rgba(0,0,0,0.7); --watermark: rgba(255,255,255,0.08);
  --success: #34c759; --warning: #ffcc00; --info: #0a84ff; --gold: #ffd700;
}
body.light {
  --bg: #f8f9fa; --bg-secondary: #ffffff; --card: #ffffff;
  --text: #1a1a1a; --text-secondary: #6c757d; --border: rgba(0,0,0,0.08);
  --watermark: rgba(0,0,0,0.1);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; transition: background 0.3s; }

header { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
.brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }
.header-actions { display: flex; gap: 15px; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 110px; }

/* MAPA Y GPS */
.map-container { height: 360px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 24px; position: relative; border: 1px solid var(--border); z-index: 1; }
#map { height: 100%; width: 100%; }
.gps-btn { position: absolute; bottom: 20px; right: 20px; z-index: 1000; background: var(--card); color: var(--text); border: none; padding: 12px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; font-size: 20px; transition: transform 0.2s; }
.gps-btn:hover { transform: scale(1.1); }
.map-legend { position: absolute; left: 16px; bottom: 16px; background: var(--overlay); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 12px; font-size: 12px; z-index: 1000; color: white; display: flex; gap: 15px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

/* GRID NOTICIAS */
.news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
.news-card { background: var(--card); border-radius: 16px; overflow: hidden; position: relative; cursor: pointer; transition: 0.3s; border: 1px solid var(--border); }
.news-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px var(--shadow); }
.news-card-image { width: 100%; aspect-ratio: 16/10; position: relative; overflow: hidden; }
.news-card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
.news-card:hover img { transform: scale(1.05); }

/* MARCA DE AGUA */
.watermark-overlay { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); pointer-events: none; z-index: 5; overflow: hidden; }
.watermark-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-25deg); color: var(--watermark); text-align: center; }
.wm-brand { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
.wm-user { font-size: 7px; font-weight: 400; margin-top: 2px; }

/* BADGES */
.price-badge { position: absolute; top: 12px; right: 12px; background: var(--overlay); color: white; padding: 6px 10px; border-radius: 8px; font-weight: 700; font-size: 13px; z-index: 10; backdrop-filter: blur(5px); }
.license-badge { position: absolute; top: 12px; left: 12px; padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; z-index: 10; text-transform: uppercase; backdrop-filter: blur(5px); }
.lic-exclusive { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.lic-nonexclusive { background: rgba(0, 122, 255, 0.9); color: white; }
.trust-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; background: rgba(52, 199, 89, 0.15); color: var(--success); border: 1px solid var(--success); margin-top: 5px; }

/* COMPONENTES */
.stats-container { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border); }
.chart-wrapper { height: 180px; width: 100%; margin-top: 15px; }
.tab-btn { padding: 5px 12px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
.tab-btn.active { background: var(--bg); color: var(--accent); }
.list-card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
.list-item { display: flex; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); align-items: center; transition: 0.2s; }
.list-item:hover { background: var(--bg); }
.list-item-image { width: 70px; height: 50px; border-radius: 8px; object-fit: cover; }
.list-item-content { flex: 1; }

/* NEGOCIACI√ìN */
.offer-section { background: var(--bg); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-top: 20px; }
.quick-offers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
.quick-offer-btn { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
.quick-offer-btn:hover { border-color: var(--gold); transform: translateY(-2px); }
.timer-box { background: rgba(255, 59, 48, 0.1); padding: 12px; border-radius: 10px; text-align: center; margin: 15px 0; border: 1px solid var(--accent); }
.timer-countdown { font-family: monospace; font-size: 26px; font-weight: 700; color: var(--accent); }

/* FORMULARIOS Y BOTONES */
.form-input { width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 10px; }
.license-option { padding: 16px; border-radius: 12px; border: 2px solid var(--border); cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
.license-option.selected { border-color: var(--accent); background: rgba(255, 59, 48, 0.05); }
.btn { padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; width: 100%; transition: 0.2s; }
.btn-primary { background: var(--accent); color: white; }
.btn-gold { background: linear-gradient(135deg, #ffd700, #ffc107); color: #664d00; }
.btn-secondary { background: var(--border); color: var(--text); }

/* MODAL */
.modal { position: fixed; inset: 0; background: var(--overlay); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
.modal.active { display: flex; }
.modal-content { background: var(--card); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

/* NAV */
.bottom-nav { position: fixed; left: 16px; right: 16px; bottom: 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; display: flex; padding: 10px; z-index: 100; box-shadow: 0 8px 32px var(--shadow); }
.nav-item { flex: 1; text-align: center; padding: 5px; cursor: pointer; font-size: 11px; color: var(--text-secondary); position: relative; }
.nav-item.active { color: var(--accent); font-weight: 700; }
.notif-badge { position: absolute; top: 2px; right: 30%; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; display: none; border: 2px solid var(--card); }
.notif-badge.active { display: block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
.view { display: none; } .view.active { display: block; }
</style>
</head>
<body class="dark">

<header>
  <div class="brand"><span style="font-size: 24px;">üì∞</span><span>Paywall News</span></div>
  <div class="header-actions">
    <button class="icon-btn" id="themeToggle" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">üåô</button>
    <button class="icon-btn" onclick="showView('profile')" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer">üë§</button>
  </div>
</header>

<div class="container">
  
  <div id="view-home" class="view active">
    <div class="map-container">
      <div id="map"></div>
      <button class="gps-btn" onclick="locateUser()">üéØ</button>
      <div class="map-legend">
        <div><span class="legend-dot" style="background: #ff3b30;"></span> Alta</div>
        <div><span class="legend-dot" style="background: #ffcc00;"></span> Media</div>
        <div><span class="legend-dot" style="background: #4cd964;"></span> Baja</div>
      </div>
    </div>
    <div class="section-header"><div class="section-title">√öltimas noticias</div></div>
    <div class="news-grid" id="homeGrid"></div>
  </div>

  <div id="view-discover" class="view">
    <div class="section-header"><div class="section-title">Explorar</div></div>
    <div style="display:flex; gap:10px; margin-bottom:20px">
        <input type="text" class="form-input" id="searchInput" placeholder="Buscar hashtags, t√≠tulos..." style="margin-bottom:0">
        <button class="icon-btn" style="background:var(--card); border:1px solid var(--border); border-radius:12px; width:50px">‚öôÔ∏è</button>
    </div>
    <div id="trendingTags" style="margin-bottom:20px; overflow-x:auto; white-space:nowrap; padding-bottom:5px"></div>
    <div class="news-grid" id="discoverGrid"></div>
  </div>

  <div id="view-upload" class="view">
    <div class="section-header"><div class="section-title">Subir contenido</div></div>
    <div class="list-card">
      <form id="uploadForm">
        <div class="form-group">
          <label class="form-label">Archivo</label>
          <input type="file" id="upFile" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">T√≠tulo</label>
          <input type="text" id="upTitle" class="form-input" required>
        </div>
        <div class="form-group">
            <label class="form-label">Hashtags (Sugeridos: <span id="sugTags" style="color:var(--accent)"></span>)</label>
            <input type="text" id="upTags" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">Licencia</label>
            <div class="license-options">
                <div class="license-option selected" onclick="selectLic(this, 'nonexclusive')"><strong>üåê No Exclusiva</strong><br><small>Venta m√∫ltiple permitida.</small></div>
                <div class="license-option" onclick="selectLic(this, 'exclusive')"><strong>üèÜ Exclusiva</strong><br><small>Un solo comprador. Mayor precio.</small></div>
                <input type="hidden" id="licInput" value="nonexclusive">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Precio (USD)</label>
            <input type="number" id="upPrice" class="form-input" placeholder="50">
        </div>
        <button type="submit" class="btn btn-primary">üì§ Analizar Metadatos y Publicar</button>
      </form>
    </div>
  </div>

  <div id="view-sales" class="view">
    <div class="section-header"><div class="section-title">Mis negocios</div></div>
    <div class="stats-container">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <strong>Rendimiento</strong>
            <div class="stats-tabs">
                <button class="tab-btn active" onclick="updateChart('week', this)">Sem</button>
                <button class="tab-btn" onclick="updateChart('month', this)">Mes</button>
                <button class="tab-btn" onclick="updateChart('year', this)">A√±o</button>
            </div>
        </div>
        <div class="chart-wrapper"><canvas id="earningsChart"></canvas></div>
    </div>
    <div id="pendingOffersCard" style="display:none; margin-bottom:20px; border:2px solid var(--warning); border-radius:16px; padding:15px; background:rgba(255,204,0,0.05)">
        <h3 style="color:var(--warning); margin-bottom:10px; font-size:16px">üîî Ofertas Recibidas</h3>
        <div id="offersList"></div>
    </div>
    <div class="list-card"><h3 style="margin-bottom:16px">Mis Ventas</h3><div id="salesList"></div></div>
    <div class="list-card"><h3 style="margin-bottom:16px">Mis Compras</h3><div id="purchasesList"></div></div>
  </div>

  <div id="view-wallet" class="view">
    <div class="section-header"><div class="section-title">Billetera</div></div>
    <div class="list-card" style="text-align:center; padding:40px 20px">
        <div style="font-size:48px; margin-bottom:10px">üí∞</div>
        <div style="color:var(--text-secondary)">Saldo disponible</div>
        <div id="walletBalance" style="font-size:42px; font-weight:800; margin:10px 0">$250</div>
        <button class="btn btn-primary" onclick="alert('Retiro iniciado')">üí∏ Retirar fondos</button>
    </div>
    <div class="list-card">
        <h3>Historial (Persistente)</h3>
        <div class="list-item"><div class="list-item-content"><div>Saldo Inicial</div><small>Registro</small></div><strong>+$250</strong></div>
    </div>
  </div>

  <div id="view-profile" class="view">
    <div class="section-header"><div class="section-title">Mi Perfil</div></div>
    <div class="list-card" style="text-align:center">
        <div style="font-size:60px">üë§</div>
        <h2 id="userNameDisplay">Juan P√©rez</h2>
        <p style="color:var(--success)">Verificado ‚úì</p>
    </div>
    <div class="list-card" onclick="showView('accounts')" style="cursor:pointer">
        <div class="list-item" style="border:none; padding:0">
            <div style="font-size:24px; margin-right:15px">üë•</div>
            <div class="list-item-content"><div class="list-item-title">Cuentas vinculadas</div><div class="list-item-meta">Gestionar equipo</div></div>
            <div>‚Ä∫</div>
        </div>
    </div>
    <div class="list-card"><button class="btn btn-secondary" onclick="resetData()">üîÅ Resetear Demo</button></div>
  </div>

  <div id="view-accounts" class="view">
    <div class="section-header"><div class="section-title">Subcuentas</div></div>
    <div class="list-card" id="subaccountsList"></div>
    <button class="btn btn-primary" onclick="alert('Nueva subcuenta')">‚ûï Agregar</button>
  </div>
</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="showView('home')"><div class="nav-item-icon">üè†</div>Inicio</div>
  <div class="nav-item" onclick="showView('discover')"><div class="nav-item-icon">üîç</div>Explorar</div>
  <div class="nav-item" onclick="showView('upload')"><div class="nav-item-icon">üì§</div>Subir</div>
  <div class="nav-item" onclick="showView('sales')"><div id="navNotif" class="notif-badge"></div><div class="nav-item-icon">üìä</div>Ventas</div>
  <div class="nav-item" onclick="showView('wallet')"><div class="nav-item-icon">üí∞</div>Wallet</div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between">
      <h3 id="modalTitle">Detalle</h3>
      <button onclick="closeModal()" style="background:none; border:none; color:var(--text); font-size:24px; cursor:pointer">‚úï</button>
    </div>
    <div id="modalBody" style="padding:20px"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ============ PERSISTENCIA Y ESTADO ============
const defaultFeed = [
  {id:1, title:'Choque en Av. Mitre', price:50, lat:-34.6037, lng:-58.3816, img:'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#accidente #transito', importance:'high', trustScore: 98},
  {id:2, title:'Incendio en F√°brica', price:150, lat:-34.6070, lng:-58.3772, img:'https://images.unsplash.com/photo-1577962917302-cd874c4e31d2?w=800', licenseType:'nonexclusive', status:'for_sale', hashtags: '#urgente #quilmes', importance:'medium', trustScore: 85},
  {id:3, title:'Robo en Joyer√≠a (Exclusivo)', price:600, lat:-34.5900, lng:-58.3800, img:'https://images.unsplash.com/photo-1590856029826-c7a73142bbf1?w=800', licenseType:'exclusive', status:'for_sale', hashtags: '#seguridad #exclusivo', importance:'high', trustScore: 99}
];
const defaultUser = { name: "Juan P√©rez", balance: 250 };
const trendTags = ["#accidente", "#politica", "#transito", "#quilmes", "#urgente"];

// Cargar estado
let feed = JSON.parse(localStorage.getItem('pw_feed')) || defaultFeed;
let currentUser = JSON.parse(localStorage.getItem('pw_user')) || defaultUser;
let salesHistory = JSON.parse(localStorage.getItem('pw_sales')) || [];
let purchases = JSON.parse(localStorage.getItem('pw_purchases')) || [];
let negotiations = JSON.parse(localStorage.getItem('pw_negs')) || [];
let subaccounts = [{name: 'Dron Norte', files: 12, img: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100'}, {name: 'C√°mara 2', files: 7, img: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100'}];

function saveData() {
    localStorage.setItem('pw_feed', JSON.stringify(feed));
    localStorage.setItem('pw_user', JSON.stringify(currentUser));
    localStorage.setItem('pw_sales', JSON.stringify(salesHistory));
    localStorage.setItem('pw_purchases', JSON.stringify(purchases));
    localStorage.setItem('pw_negs', JSON.stringify(negotiations));
    updateWalletUI();
}
function resetData() { localStorage.clear(); location.reload(); }

let earningsChart = null;
let activeInterval = null;
const cashSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2012/2012-preview.mp3');

// ============ MAPA CON PRIVACIDAD (GEOFENCING) ============
let map = null;
let markersLayer = L.layerGroup();
let userMarker = null;

function initMap() {
  if (map) return;
  map = L.map('map', {zoomControl: false}).setView([-34.6037, -58.3816], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  markersLayer.addTo(map);
  renderMapMarkers();
}

function getObfuscatedCoords(lat, lng) {
    // Desviaci√≥n de ~200-300 metros para privacidad
    const noise = 0.003; 
    return [lat + (Math.random() - 0.5) * noise, lng + (Math.random() - 0.5) * noise];
}

function renderMapMarkers() {
    markersLayer.clearLayers();
    feed.forEach(item => {
        // L√ìGICA DE PRIVACIDAD: Si est√° vendida o es m√≠a, veo real. Si no, veo ofuscado.
        // Para demo: Si status es 'sold', asumimos que el usuario actual tiene acceso.
        const hasAccess = item.status === 'sold';
        const displayCoords = hasAccess ? [item.lat, item.lng] : getObfuscatedCoords(item.lat, item.lng);
        const color = item.importance === 'high' ? '#ff3b30' : (item.importance === 'medium' ? '#ffcc00' : '#4cd964');

        const markerHtml = `<div style="width:24px;height:24px;background:${color};border-radius:50% 50% 50% 0;transform:rotate(45deg);border:2px solid white;box-shadow:0 3px 8px rgba(0,0,0,0.3);"></div>`;
        
        const marker = L.marker(displayCoords, {
            icon: L.divIcon({ className: '', html: markerHtml, iconSize: [24,24] })
        }).addTo(markersLayer);
        
        marker.on('click', () => openDetail(item.id));

        // C√≠rculo de Incertidumbre para items no comprados
        if (!hasAccess) {
            L.circle(displayCoords, {
                color: color, fillColor: color, fillOpacity: 0.1,
                radius: 400, // 400m de radio de incertidumbre
                weight: 1, dashArray: '5, 5'
            }).addTo(markersLayer);
        }
    });
}

function locateUser() {
    if (!navigator.geolocation) return alert("GPS no soportado");
    navigator.geolocation.getCurrentPosition(pos => {
        const {latitude, longitude} = pos.coords;
        map.setView([latitude, longitude], 14);
        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({html: '<div style="background:#007aff;width:15px;height:15px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 10px rgba(0,122,255,0.2)"></div>'})
        }).addTo(map);
        alert(`üìç Ubicaci√≥n encontrada.\nMostrando noticias en tu zona.`);
    }, () => alert("Error al obtener ubicaci√≥n"));
}

// ============ RENDER UI ============
function generateWatermark() {
  let cells = '';
  for(let i=0; i<9; i++) cells += `<div class="watermark-cell"><span class="wm-brand">Paywall News</span><span class="wm-user">${currentUser.name}</span></div>`;
  return `<div class="watermark-overlay">${cells}</div>`;
}

function getTrustBadge(score) {
    return score > 90 ? `<div class="trust-badge">üõ°Ô∏è GPS VERIFICADO</div>` : '';
}

function renderGrid(id, items) {
  const container = document.getElementById(id);
  if(!container) return;
  container.innerHTML = items.map(item => `
    <div class="news-card" onclick="openDetail(${item.id})">
      <div class="news-card-image">
        <img src="${item.img}">
        ${item.status !== 'sold' ? generateWatermark() : ''}
        <div class="price-badge">$${item.price}</div>
        <div class="license-badge ${item.licenseType === 'exclusive' ? 'lic-exclusive' : 'lic-nonexclusive'}">${item.licenseType === 'exclusive' ? 'üèÜ' : 'üåê'}</div>
      </div>
      <div style="padding:15px">
        <div class="list-item-title">${item.title}</div>
        ${getTrustBadge(item.trustScore || 0)}
        <div style="font-size:12px; color:var(--info); margin:5px 0">${item.hashtags}</div>
        <small style="color:${item.status === 'for_sale' ? 'var(--success)' : 'var(--warning)'}">${item.status === 'for_sale' ? '‚óè Disponible' : '‚óè Negociando'}</small>
      </div>
    </div>`).join('');
}

// ============ DETALLE Y COMPRA ============
function openDetail(id) {
  const item = feed.find(x => x.id === id);
  document.getElementById('modalTitle').textContent = item.title;
  const isSold = item.status === 'sold';
  
  let ui = `<div style="position:relative; border-radius:12px; overflow:hidden; margin-bottom:15px">
                <img src="${item.img}" style="width:100%">
                ${!isSold ? generateWatermark() : ''}
            </div>
            ${getTrustBadge(item.trustScore || 0)}
            <p style="margin:10px 0; color:var(--text-secondary)">${item.hashtags}</p>`;

  if(isSold) {
      ui += `<div class="list-card" style="text-align:center; border-color:var(--success); background:rgba(52,199,89,0.1)">
                <h3 style="color:var(--success)">‚úÖ Contenido Adquirido</h3>
                <p>Ubicaci√≥n exacta revelada en el mapa.</p>
             </div>`;
  } else if(item.licenseType === 'exclusive') {
      ui += `<button class="btn btn-gold" onclick="buyDirect(${item.id})">COMPRAR EXCLUSIVIDAD $${item.price}</button>`;
  } else {
      ui += `
        <button class="btn btn-primary" style="margin-bottom:15px" onclick="buyDirect(${item.id})">Comprar Licencia Compartida $${item.price}</button>
        <div class="offer-section">
            <h4 style="text-align:center; color:var(--gold); margin-bottom:10px">üíé Negociar</h4>
            <div class="quick-offers">
                <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*2})"><strong>X2</strong><br>$${item.price*2}</div>
                <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*3})"><strong>X3</strong><br>$${item.price*3}</div>
                <div class="quick-offer-btn" onclick="makeOffer(${item.id}, ${item.price*4})"><strong>X4</strong><br>$${item.price*4}</div>
            </div>
            <div style="display:flex; gap:10px">
                <input type="number" id="cOffer" placeholder="Monto..." class="form-input" style="margin:0">
                <button class="btn btn-gold" style="width:auto" onclick="sendManualOffer(${item.id})">Enviar</button>
            </div>
        </div>`;
  }
  document.getElementById('modalBody').innerHTML = ui;
  document.getElementById('modal').classList.add('active');
}

function buyDirect(id) {
    const item = feed.find(x => x.id === id);
    if(currentUser.balance < item.price) return alert("Saldo insuficiente");
    
    // Transacci√≥n
    currentUser.balance -= item.price;
    item.status = 'sold'; // Simular venta al usuario
    purchases.unshift({title: item.title, price: item.price, date: new Date().toLocaleString(), img: item.img});
    
    saveData();
    renderMapMarkers(); // Actualizar mapa para mostrar ubicaci√≥n exacta
    closeModal();
    renderAllViews();
    alert("‚úÖ Compra exitosa. La ubicaci√≥n exacta ha sido revelada en el mapa.");
}

// ============ SUBIR NOTICIA (VERIFICACI√ìN) ============
document.getElementById('uploadForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    const originalText = btn.textContent;
    btn.textContent = "üõ∞Ô∏è Verificando sat√©lites...";
    btn.disabled = true;

    setTimeout(() => {
        const title = document.getElementById('upTitle').value;
        const price = Number(document.getElementById('upPrice').value);
        const tags = document.getElementById('upTags').value;
        const lic = document.getElementById('licInput').value;
        
        const newItem = {
            id: Date.now(),
            title: title,
            price: price,
            lat: -34.6037 + (Math.random()-0.5)*0.05,
            lng: -58.3816 + (Math.random()-0.5)*0.05,
            img: 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800',
            licenseType: lic,
            status: 'for_sale',
            hashtags: tags,
            importance: 'high',
            trustScore: 95 // Simulado alto
        };
        
        feed.unshift(newItem);
        saveData();
        renderMapMarkers();
        renderAllViews();
        e.target.reset();
        closeModal();
        showView('home');
        
        btn.textContent = originalText;
        btn.disabled = false;
        alert("‚úÖ Noticia subida y verificada criptogr√°ficamente.");
    }, 1500);
});

// ============ NEGOCIACI√ìN, VISTAS, ETC ============
function makeOffer(itemId, amount) {
    const expiresAt = Date.now() + (15 * 60 * 1000);
    negotiations.push({ id: Date.now(), newsId: itemId, amount, status: 'pending', expiresAt });
    feed.find(x => x.id === itemId).status = 'negotiating';
    saveData();
    document.getElementById('navNotif').classList.add('active');
    closeModal(); renderAllViews();
}
function sendManualOffer(id) {
    const val = Number(document.getElementById('cOffer').value);
    if(val > 0) makeOffer(id, val);
}
function showSellerPanel(negId) {
    const neg = negotiations.find(n => n.id === negId);
    const item = feed.find(f => f.id === neg.newsId);
    document.getElementById('modalTitle').textContent = 'Oferta';
    document.getElementById('modalBody').innerHTML = `
        <div class="timer-box"><small>EXPIRA EN</small><div id="countdown" class="timer-countdown">15:00</div></div>
        <div style="text-align:center; padding:20px; background:var(--bg); border-radius:15px; margin-bottom:15px">
            <h1 style="color:var(--gold); font-size:42px">$${neg.amount}</h1><p>${item.title}</p>
        </div>
        <button class="btn btn-primary" onclick="acceptOffer(${negId})">ACEPTAR</button>
        <div style="margin-top:15px"><input type="number" class="form-input" placeholder="Contraoferta..."><button class="btn btn-secondary" onclick="alert('Enviada')">Contraofertar</button></div>`;
    document.getElementById('modal').classList.add('active');
}
function acceptOffer(id) {
    const neg = negotiations.find(n => n.id === id);
    const item = feed.find(f => f.id === neg.newsId);
    cashSound.play().catch(()=>{});
    item.status = 'sold'; neg.status = 'accepted';
    currentUser.balance += neg.amount;
    salesHistory.unshift({title: item.title, amount: neg.amount, date: new Date().toLocaleString(), img: item.img});
    saveData();
    closeModal(); renderAllViews();
}

function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById(`view-${name}`).style.display = 'block';
    if(name === 'home') setTimeout(() => { if(!map) initMap(); else { map.invalidateSize(); renderMapMarkers(); } }, 100);
    if(name === 'sales') { renderSales(); if(!earningsChart) initChart(); }
    if(name === 'discover') { renderGrid('discoverGrid', feed); renderTrends(); }
    if(name === 'upload') document.getElementById('sugTags').textContent = trendTags.slice(0,3).join(", ");
    if(name === 'accounts') renderSubs();
    if(name === 'wallet') updateWalletUI();
}

function updateWalletUI() {
    document.getElementById('walletBalance').textContent = `$${currentUser.balance}`;
}

// Chart, Trends, Aux
function initChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    earningsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'], datasets: [{ data: [50,90,45,130,110,200,75], backgroundColor: '#ff3b30', borderRadius:4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y:{display:false}, x:{grid:{display:false}} } }
    });
}
function updateChart(p, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
    if(p==='year') { earningsChart.data.labels=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']; earningsChart.data.datasets[0].data=[1200,1500,1100,1700,1900,2400,2000,2100,2300,2700,2500,3400]; }
    else { earningsChart.data.labels=['Lun','Mar','Mie','Jue','Vie','Sab','Dom']; earningsChart.data.datasets[0].data=[50,90,45,130,110,200,75]; }
    earningsChart.update();
}
function renderSales() {
    const pending = negotiations.filter(n => n.status === 'pending');
    document.getElementById('pendingOffersCard').style.display = pending.length ? 'block' : 'none';
    document.getElementById('offersList').innerHTML = pending.map(n => `<div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:10px; border-radius:10px; margin-bottom:8px"><div><strong>$${n.amount}</strong><br><small>Pendiente</small></div><button class="btn btn-primary" style="width:auto; padding:8px 15px" onclick="showSellerPanel(${n.id})">Ver</button></div>`).join('');
    document.getElementById('salesList').innerHTML = salesHistory.map(s => `<div class="list-item"><img src="${s.img}" class="list-item-image"><div class="list-item-content"><div class="list-item-title">${s.title}</div><small>${s.date}</small></div><strong style="color:var(--success)">+$${s.amount}</strong></div>`).join('');
    document.getElementById('purchasesList').innerHTML = purchases.map(p => `<div class="list-item"><img src="${p.img}" class="list-item-image"><div class="list-item-content"><div class="list-item-title">${p.title}</div><small>${p.date}</small></div><strong style="color:var(--accent)">-$${p.price}</strong></div>`).join('');
}
function renderTrends() { document.getElementById('trendingTags').innerHTML = trendTags.map(t => `<span style="display:inline-block; background:rgba(255,59,48,0.1); padding:6px 15px; border-radius:20px; color:var(--accent); margin-right:10px; cursor:pointer" onclick="document.getElementById('searchInput').value='${t}'; showView('discover')">${t}</span>`).join(''); }
function renderSubs() { document.getElementById('subaccountsList').innerHTML = subaccounts.map(s => `<div class="list-item"><img src="${s.img}" class="list-item-image" style="border-radius:50%; width:50px; height:50px"><div class="list-item-content"><div>${s.name}</div><small>${s.files} archivos</small></div></div>`).join(''); }
function selectLic(el, type) { document.querySelectorAll('.license-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); document.getElementById('licInput').value = type; }
function closeModal() { document.getElementById('modal').classList.remove('active'); clearInterval(activeInterval); }
function logout() { if(confirm('¬øSalir?')) location.reload(); }

// INIT
document.getElementById('themeToggle').onclick = () => document.body.classList.toggle('light');
document.getElementById('searchInput').oninput = (e) => { const v = e.target.value.toLowerCase(); renderGrid('discoverGrid', feed.filter(i => i.title.toLowerCase().includes(v) || i.hashtags.toLowerCase().includes(v))); };
showView('home');
</script>
</body>
</html>